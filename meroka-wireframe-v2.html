<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Healthcare's Open Secret</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { background: #fafbfc; font-family: -apple-system, BlinkMacSystemFont, 'Inter', sans-serif; overflow-x: auto; }

.header { text-align: left; padding: 20px 0 6px 24px; position: relative; }
h1 { font-size: 28px; font-weight: 800; color: #1a237e; letter-spacing: -0.5px; }
.subtitle { font-size: 11px; color: #64748b; margin-top: 3px; font-weight: 500; }

/* Status controls — top right */
.status-controls {
  position: absolute; top: 12px; right: 24px;
  display: flex; gap: 6px; align-items: center; flex-wrap: wrap; justify-content: flex-end; max-width: 460px;
}
.status-btn {
  padding: 4px 10px; border-radius: 6px; font-size: 9px; font-weight: 700;
  border: 1.5px solid #ddd; background: #fff; color: #666; cursor: pointer;
  transition: all 0.2s; text-transform: uppercase; letter-spacing: 0.5px;
}
.status-btn:hover { border-color: #aaa; color: #333; }
.status-btn.active { border-color: #22c55e; background: #f0fdf4; color: #16a34a; }
.status-btn.active-blue { border-color: #6366f1; background: #eef2ff; color: #4f46e5; }
.status-btn.active-amber { border-color: #f59e0b; background: #fffbeb; color: #b45309; }
.status-btn.active-red { border-color: #ef4444; background: #fef2f2; color: #dc2626; }

/* Pipeline */
.pipe-wrap { position: relative; padding: 16px 24px 32px; }
.pipeline { display: flex; align-items: stretch; gap: 0; min-width: 1380px; }
.stage { flex-shrink: 0; }
.stage-label {
  font-size: 9px; font-weight: 800; text-transform: uppercase;
  letter-spacing: 2px; color: #999; text-align: center; margin-bottom: 10px;
}

/* Flow arrows */
.flow-arrow {
  display: flex; align-items: center; justify-content: center;
  width: 36px; flex-shrink: 0; position: relative;
}
.flow-arrow::before {
  content: ''; position: absolute; top: 10%; bottom: 10%; left: 50%;
  width: 2px; background: linear-gradient(to bottom, transparent, #ddd 15%, #ddd 85%, transparent);
  transform: translateX(-50%);
}
.flow-arrow .arr { background: #fafbfc; padding: 6px 0; z-index: 1; color: #bbb; font-size: 22px; line-height: 1; }

/* === SOURCES === */
.sources-stage { width: 260px; }
.source-group { margin-bottom: 8px; border: 1.5px solid #e0e0e0; border-radius: 7px; background: #fff; overflow: hidden; }
.sg-header {
  padding: 6px 10px; font-size: 9px; font-weight: 700;
  text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid #eee;
}
.sg-gov .sg-header { background: #e8f0fe; color: #1a56db; }
.sg-cost .sg-header { background: #e6f4ea; color: #137333; }
.sg-quality .sg-header { background: #fef7e0; color: #b05e0a; }
.sg-web .sg-header { background: #fce8e6; color: #c5221f; }
.sg-employer .sg-header { background: #f3e8fd; color: #7627bb; }
.sg-ai .sg-header { background: #fce4ec; color: #c62828; }
.sg-legal .sg-header { background: #e8eaf6; color: #283593; }

/* State law expandable row */
.src-item.state-law-row { flex-wrap: wrap; padding-bottom: 0; }
.state-law-toggle {
  display: flex; align-items: center; gap: 4px; width: 100%; cursor: pointer; padding-bottom: 5px;
}
.state-law-toggle .sn { flex: 1; }
.state-law-badge {
  font-size: 7px; font-weight: 800; padding: 2px 6px; border-radius: 7px;
  background: #e8eaf6; color: #283593; letter-spacing: 0.3px; flex-shrink: 0;
}
.state-law-expand-icon {
  font-size: 10px; color: #999; transition: transform 0.2s; flex-shrink: 0; margin-left: 2px;
}
.state-law-row.expanded .state-law-expand-icon { transform: rotate(90deg); }
.state-law-children {
  display: none; width: 100%; border-top: 1px solid #f0f0f0; margin-top: 0;
}
.state-law-row.expanded .state-law-children { display: block; }
.state-law-state {
  padding: 4px 10px 4px 20px; font-size: 9px; display: flex; align-items: center;
  gap: 6px; border-bottom: 1px solid #f8f8f8; cursor: pointer; transition: background 0.15s;
}
.state-law-state:last-child { border-bottom: none; }
.state-law-state:hover { background: #f5f6ff; }
.state-law-state .sls-name { font-weight: 600; color: #333; flex: 1; }
.state-law-state .sls-count {
  font-size: 7px; font-weight: 700; color: #888; background: #f3f4f6;
  padding: 1px 5px; border-radius: 4px;
}
.m-legal { background: #e8eaf6; color: #283593; }

.src-item {
  padding: 5px 10px; font-size: 10px; display: flex; align-items: center;
  justify-content: space-between; border-bottom: 1px solid #f5f5f5;
  cursor: pointer; transition: opacity 0.2s, background 0.15s;
}
.src-item:last-child { border-bottom: none; }
.src-item:hover { background: #f8f9ff; }
.src-item .sn { font-weight: 600; color: #333; flex: 1; }
.src-item .sm {
  font-size: 7px; font-weight: 800; text-transform: uppercase;
  padding: 2px 5px; border-radius: 7px; letter-spacing: 0.4px; flex-shrink: 0; margin-left: 4px;
}
.m-csv { background: #e3f2fd; color: #1565c0; }
.m-api { background: #e8f5e9; color: #2e7d32; }
.m-json { background: #e0f7fa; color: #00838f; }
.m-scraper { background: #fff3e0; color: #e65100; }
.m-agent { background: #fce4ec; color: #c62828; }
.m-derived { background: #f3e5f5; color: #6a1b9a; }
.m-curated { background: #f5f5f5; color: #555; }

/* Source status badges */
.src-status-badge {
  display: none; font-size: 10px; margin-left: 4px; flex-shrink: 0;
}
.pipeline.show-status .src-item.src-completed .src-status-badge {
  display: inline; color: #22c55e;
}

/* Source effort dots */
.src-effort {
  display: none; width: 6px; height: 6px; border-radius: 50%; margin-left: 5px; flex-shrink: 0;
}
.effort-low { background: #86efac; }
.effort-med { background: #fcd34d; }
.effort-high { background: #fb923c; }
.effort-vhigh { background: #f87171; }
.pipeline.show-effort .src-effort { display: inline-block; }

/* Impact mode — sources become clickable */
.pipeline.impact-mode .src-item { cursor: pointer; }
.pipeline.impact-mode .src-item:hover { background: #fff0f0; }
.src-item.impact-locked { background: #fef2f2 !important; border-left: 3px solid #ef4444; }

/* === LAKE === */
.lake-stage { width: 110px; }
.lake-box {
  background: #fff;
  border: 1.5px solid #e0e4ea;
  border-radius: 10px; height: 100%; min-height: 400px;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  padding: 16px 8px; color: #1a237e; text-align: center; position: relative; overflow: hidden;
  transition: opacity 0.2s, box-shadow 0.3s;
}
.lake-box::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
  background: repeating-linear-gradient(0deg, transparent, transparent 28px, rgba(26,35,126,0.02) 28px, rgba(26,35,126,0.02) 29px);
}
.lake-title { font-size: 13px; font-weight: 800; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 14px; z-index: 1; color: #1a237e; }
.lake-fmt { font-size: 8px; font-weight: 600; background: #f0f1f8; color: #3949ab; padding: 3px 8px; border-radius: 10px; margin: 2px 0; z-index: 1; }
.lake-box.hl { box-shadow: 0 0 20px rgba(21,101,192,0.15); border-color: #90caf9; }

/* === WAREHOUSE === */
.warehouse-stage { width: 520px; }
.wh-box {
  border: 2px solid #111; border-radius: 10px; background: #f8f8fc;
  padding: 14px; height: 100%;
}
.wh-title {
  font-size: 11px; font-weight: 800; text-transform: uppercase;
  letter-spacing: 2px; color: #111; text-align: center; margin-bottom: 12px;
}
.fsec { margin-bottom: 8px; }
.fsec-label { font-size: 8px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: #999; margin-bottom: 3px; padding-left: 2px; }
.frow { display: flex; flex-wrap: wrap; gap: 3px; }
.field {
  padding: 3px 7px; border-radius: 4px; font-size: 9px;
  font-family: 'SF Mono', 'Fira Code', monospace; font-weight: 600;
  border: 1.5px solid; cursor: default; white-space: nowrap;
  transition: opacity 0.2s, transform 0.15s, box-shadow 0.15s, border-color 0.2s;
  position: relative;
}
.field:hover { transform: scale(1.05); z-index: 2; position: relative; }

.f-identity { background: #eef; border-color: #aac; color: #336; }
.f-roster { background: #eef; border-color: #aac; color: #336; }
.f-independence { background: #fee; border-color: #daa; color: #633; }
.f-services { background: #efe; border-color: #ada; color: #363; }
.f-revenue { background: #efe; border-color: #ada; color: #363; }
.f-quality { background: #ffe; border-color: #dda; color: #663; }
.f-satisfaction { background: #ffe; border-color: #dda; color: #663; }
.f-comparison { background: #fef; border-color: #dad; color: #636; }
.f-employer { background: #fef; border-color: #dad; color: #636; }
.f-rural { background: #e8faf0; border-color: #a3d9bc; color: #1a5632; }
.f-legal { background: #e8eaf6; border-color: #9fa8da; color: #283593; }

/* Affiliations tab */
.affil-tier { margin-bottom: 16px; }
.affil-tier-label {
  font-size: 8px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.8px;
  color: #999; margin-bottom: 8px; padding-bottom: 4px; border-bottom: 1px solid #f0f0f0;
}
.affil-card {
  padding: 8px 10px; border: 1px solid #e5e7eb; border-radius: 6px;
  margin-bottom: 6px; cursor: default; transition: all 0.15s; position: relative;
}
.affil-card:hover { border-color: #c7d2fe; background: #fafbff; }
.affil-card:hover .affil-contact { display: block; }
.affil-name { font-size: 10px; font-weight: 700; color: #111; }
.affil-why { font-size: 9px; color: #666; line-height: 1.5; margin-top: 2px; }
.affil-status {
  display: inline-block; font-size: 7px; font-weight: 700; padding: 1px 6px;
  border-radius: 4px; margin-top: 4px; text-transform: uppercase; letter-spacing: 0.3px;
}
.affil-status.as-target { background: #f3f4f6; color: #6b7280; border: 1px solid #d1d5db; }
.affil-status.as-outreach { background: #fef3c7; color: #92400e; border: 1px solid #fde68a; }
.affil-status.as-affiliated { background: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
.affil-contact {
  display: none; margin-top: 6px; padding: 6px 8px; background: #f8f9ff; border-radius: 4px;
  border: 1px solid #e8eaf6; font-size: 8px; color: #444; line-height: 1.6;
}
.affil-contact a {
  color: #4f46e5; text-decoration: none; border-bottom: 1px dashed #c7d2fe;
  word-break: break-all;
}
.affil-contact a:hover { color: #6366f1; border-bottom-color: #6366f1; }
.f-technology { background: #eef; border-color: #aac; color: #336; }

/* Heatmap mode */
.field .heat-dot {
  display: none; position: absolute; top: -3px; right: -3px;
  width: 8px; height: 8px; border-radius: 50%; border: 1px solid #fff;
  font-size: 0; z-index: 3;
}
.pipeline.show-heatmap .field .heat-dot { display: block; }
.heat-0 { background: #d1d5db; }
.heat-1 { background: #93c5fd; }
.heat-2 { background: #fbbf24; }
.heat-3 { background: #fb923c; }
.heat-4 { background: #ef4444; }
.pipeline.show-heatmap .field.heat-unused { opacity: 0.35; }

/* Risk mode — single source indicator */
.field .risk-dot {
  display: none; position: absolute; bottom: -3px; left: -3px;
  width: 7px; height: 7px; border-radius: 50%; border: 1px solid #fff;
  z-index: 3; background: #ef4444;
}
.pipeline.show-risk .field.single-source .risk-dot { display: block; }
.pipeline.show-risk .field.multi-source { border-color: #22c55e; }

/* Field tooltip */
.field-tooltip {
  display: none; position: absolute; bottom: calc(100% + 6px); left: 50%; transform: translateX(-50%);
  background: #1e293b; color: #f8fafc; padding: 5px 8px; border-radius: 5px;
  font-size: 8px; font-family: -apple-system, BlinkMacSystemFont, 'Inter', sans-serif;
  font-weight: 500; white-space: nowrap; z-index: 100; pointer-events: none;
  line-height: 1.4; max-width: 220px; white-space: normal; text-align: left;
}
.field-tooltip::after {
  content: ''; position: absolute; top: 100%; left: 50%; transform: translateX(-50%);
  border: 4px solid transparent; border-top-color: #1e293b;
}
.field:hover .field-tooltip { display: block; }

/* Field selection mode (for create form) */
.field.selectable { cursor: pointer; }
.field.selectable:hover { box-shadow: 0 0 0 2px rgba(99,102,241,0.5); transform: scale(1.08); }
.field.selected { box-shadow: 0 0 0 2.5px #6366f1; transform: scale(1.06); z-index: 2; position: relative; }

/* === PROJECTS === */
.projects-stage { width: 300px; }
.proj-box {
  border: 2px solid #ddd; border-radius: 10px; background: #fff;
  padding: 14px; margin-bottom: 12px; cursor: default;
  transition: opacity 0.2s, border-color 0.3s, box-shadow 0.3s;
}
.proj-box:hover, .proj-box.hl { border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99,102,241,0.15); }
.proj-header { display: flex; align-items: center; gap: 8px; cursor: pointer; }
.proj-name { font-size: 13px; font-weight: 700; color: #111; margin-bottom: 5px; }
.proj-desc { font-size: 9px; color: #666; line-height: 1.5; margin-bottom: 6px; }
.proj-meta { font-size: 8px; font-weight: 700; color: #6366f1; text-transform: uppercase; letter-spacing: 0.5px; }
.proj-placeholder { border-style: dashed; border-color: #ddd; background: #fafafa; }
.proj-placeholder .proj-name { color: #bbb; }
.proj-placeholder .proj-desc { color: #ccc; font-style: italic; }

/* Project type badges */
.proj-type-badge {
  display: inline-block; padding: 2px 8px; border-radius: 10px;
  font-size: 8px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.8px;
  flex-shrink: 0; margin-bottom: 5px;
}
.proj-type-badge.external { background: #eef2ff; color: #4f46e5; border: 1px solid #c7d2fe; }
.proj-type-badge.internal { background: #f3f4f6; color: #6b7280; border: 1px solid #d1d5db; }

/* Source detail card */
.source-overlay {
  display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.25); z-index: 200;
  justify-content: center; align-items: flex-start; padding: 40px 24px;
}
.source-overlay.open { display: flex; }
.source-panel {
  background: #fff; border-radius: 14px; width: 520px; max-height: calc(100vh - 80px);
  overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.2), 0 0 0 1px rgba(0,0,0,0.05);
  transform: translateY(12px) scale(0.97); opacity: 0;
  transition: transform 0.2s ease, opacity 0.2s ease;
}
.source-overlay.open .source-panel {
  transform: translateY(0) scale(1); opacity: 1;
}
.src-card-header {
  padding: 20px 24px 14px; border-bottom: 1px solid #eee;
  display: flex; align-items: flex-start; gap: 12px; position: sticky; top: 0;
  background: #fff; border-radius: 14px 14px 0 0; z-index: 1;
}
.src-card-header-info { flex: 1; }
.src-card-title {
  font-size: 16px; font-weight: 800; color: #111; display: flex; align-items: center; gap: 8px;
}
.src-card-agency {
  font-size: 9px; font-weight: 600; color: #888; margin-top: 4px;
}
.src-card-body { padding: 16px 24px 24px; }
.src-card-row {
  display: flex; gap: 8px; margin-bottom: 14px;
}
.src-card-label {
  font-size: 8px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.6px;
  color: #999; width: 80px; flex-shrink: 0; padding-top: 2px;
}
.src-card-value {
  font-size: 10px; color: #333; line-height: 1.6; flex: 1;
}
.src-card-value a {
  color: #4f46e5; text-decoration: none; border-bottom: 1px dashed #c7d2fe;
  word-break: break-all;
}
.src-card-value a:hover { color: #6366f1; border-bottom-color: #6366f1; }
.src-card-pills {
  display: flex; flex-wrap: wrap; gap: 4px; margin-top: 2px;
}
.src-card-pill {
  padding: 2px 8px; border-radius: 4px; font-size: 8px; font-weight: 700;
  border: 1px solid #e5e7eb; background: #f9fafb; color: #555;
}
.src-card-pill.pill-format { background: #eef2ff; color: #4f46e5; border-color: #c7d2fe; }
.src-card-pill.pill-free { background: #f0fdf4; color: #16a34a; border-color: #bbf7d0; }
.src-card-pill.pill-paid { background: #fef3c7; color: #b45309; border-color: #fde68a; }
.src-card-pill.pill-restricted { background: #fef2f2; color: #dc2626; border-color: #fecaca; }
.src-card-note {
  font-size: 9px; color: #666; line-height: 1.6; padding: 8px 10px;
  background: #fafbfc; border-radius: 6px; border: 1px solid #f0f0f0; margin-top: 2px;
}
.src-card-divider {
  height: 1px; background: #f0f0f0; margin: 4px 0 14px;
}
.src-card-stat-row {
  display: flex; gap: 8px; margin-bottom: 14px;
}
.src-card-stat {
  flex: 1; padding: 8px 10px; border-radius: 6px; border: 1px solid #f0f0f0;
  text-align: center;
}
.src-card-stat-val {
  font-size: 13px; font-weight: 800; color: #111;
}
.src-card-stat-label {
  font-size: 7px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.4px;
  color: #999; margin-top: 2px;
}

/* Detail panel overlay */
.detail-overlay {
  display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.25); z-index: 200;
  justify-content: center; align-items: flex-start; padding: 40px 24px;
}
.detail-overlay.open { display: flex; }
.detail-panel {
  background: #fff; border-radius: 14px; width: 560px; max-height: calc(100vh - 80px);
  overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.2), 0 0 0 1px rgba(0,0,0,0.05);
  transform: translateY(12px) scale(0.97); opacity: 0;
  transition: transform 0.2s ease, opacity 0.2s ease;
}
.detail-overlay.open .detail-panel {
  transform: translateY(0) scale(1); opacity: 1;
}
.detail-panel-header {
  padding: 20px 24px 14px; border-bottom: 1px solid #eee;
  display: flex; align-items: flex-start; gap: 12px; position: sticky; top: 0;
  background: #fff; border-radius: 14px 14px 0 0; z-index: 1;
}
.detail-panel-header-info { flex: 1; }
.detail-panel-title {
  font-size: 17px; font-weight: 800; color: #111; display: flex; align-items: center; gap: 8px;
}
.detail-panel-desc {
  font-size: 10px; color: #666; line-height: 1.5; margin-top: 6px;
}
.detail-panel-meta {
  font-size: 9px; font-weight: 700; color: #6366f1; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 6px;
}
.detail-close {
  background: #f3f4f6; border: none; width: 32px; height: 32px; border-radius: 8px;
  font-size: 18px; cursor: pointer; color: #999; display: flex; align-items: center; justify-content: center;
  flex-shrink: 0; transition: all 0.15s;
}
.detail-close:hover { background: #e5e7eb; color: #333; }
.detail-panel-body {
  padding: 0 24px 24px;
}

/* Detail tabs */
.detail-tabs {
  display: flex; gap: 0; border-bottom: 2px solid #eee; margin: 0 -24px;
  padding: 0 24px; position: sticky; top: 0; background: #fff; z-index: 1;
}
.detail-tab {
  padding: 10px 16px; font-size: 10px; font-weight: 700; text-transform: uppercase;
  letter-spacing: 0.8px; color: #999; cursor: pointer; border-bottom: 2px solid transparent;
  margin-bottom: -2px; transition: all 0.15s; background: none; border-top: none; border-left: none; border-right: none;
}
.detail-tab:hover { color: #555; }
.detail-tab.active { color: #6366f1; border-bottom-color: #6366f1; }
.detail-tab-content { display: none; padding-top: 16px; }
.detail-tab-content.active { display: block; }

/* Architecture diagram */
.arch-flow { display: flex; flex-direction: column; align-items: center; gap: 0; }
.arch-arrow {
  width: 2px; height: 20px; background: #d1d5db; position: relative;
}
.arch-arrow::after {
  content: ''; position: absolute; bottom: -4px; left: 50%; transform: translateX(-50%);
  border-left: 5px solid transparent; border-right: 5px solid transparent; border-top: 5px solid #d1d5db;
}
.arch-arrow-label {
  font-size: 7px; font-weight: 700; color: #aaa; text-transform: uppercase; letter-spacing: 0.5px;
  position: absolute; left: 10px; top: 50%; transform: translateY(-50%); white-space: nowrap;
}
.arch-node {
  border: 1.5px solid #e0e0e0; border-radius: 8px; background: #fff;
  padding: 10px 14px; width: 100%; text-align: left;
  transition: border-color 0.15s;
}
.arch-node:hover { border-color: #c7d2fe; }
.arch-node-header { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
.arch-node-icon {
  width: 28px; height: 28px; border-radius: 6px; display: flex; align-items: center;
  justify-content: center; font-size: 14px; flex-shrink: 0;
}
.arch-node-name { font-size: 11px; font-weight: 700; color: #111; }
.arch-node-desc { font-size: 9px; color: #666; line-height: 1.4; }
.arch-node-detail { font-size: 8px; color: #888; margin-top: 4px; line-height: 1.5; }
.arch-node-children {
  display: flex; flex-wrap: wrap; gap: 4px; margin-top: 6px;
}
.arch-child {
  padding: 3px 8px; border-radius: 4px; font-size: 8px; font-weight: 600;
  font-family: 'SF Mono', 'Fira Code', monospace;
  background: #f8f8fc; border: 1px solid #e8e8e8; color: #555;
}
.arch-tables {
  display: flex; flex-wrap: wrap; gap: 3px; margin-top: 6px;
}
.arch-table {
  padding: 2px 7px; border-radius: 4px; font-size: 8px; font-weight: 600;
  font-family: 'SF Mono', 'Fira Code', monospace;
  border: 1px solid; display: flex; align-items: center; gap: 4px;
}
.arch-table .at-status { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
.at-done { background: #22c55e; }
.at-wip { background: #eab308; }
.at-pending { background: #d1d5db; }
.arch-cost {
  display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 7px;
  font-weight: 700; background: #f3f4f6; color: #888; margin-left: auto; flex-shrink: 0;
}
/* Node type colors */
.arch-t-interface .arch-node-icon { background: #dbeafe; color: #2563eb; }
.arch-t-compute .arch-node-icon { background: #e0e7ff; color: #4f46e5; }
.arch-t-ai .arch-node-icon { background: #fce7f3; color: #db2777; }
.arch-t-storage .arch-node-icon { background: #d1fae5; color: #059669; }
.arch-t-output .arch-node-icon { background: #fef3c7; color: #b45309; }
.arch-t-interface .arch-node { border-left: 3px solid #93c5fd; }
.arch-t-compute .arch-node { border-left: 3px solid #a5b4fc; }
.arch-t-ai .arch-node { border-left: 3px solid #f9a8d4; }
.arch-t-storage .arch-node { border-left: 3px solid #6ee7b7; }
.arch-t-output .arch-node { border-left: 3px solid #fcd34d; }
/* Horizontal split row */
.arch-row { display: flex; gap: 8px; width: 100%; }
.arch-row > * { flex: 1; }

/* Phases */
.phase-card {
  border: 1.5px solid #e0e0e0; border-radius: 10px; background: #fff; margin-bottom: 12px; overflow: hidden;
}
.phase-card.phase-active { border-color: #6366f1; }
.phase-header {
  padding: 12px 14px; display: flex; align-items: flex-start; gap: 10px;
}
.phase-status-ring {
  width: 36px; height: 36px; border-radius: 50%; flex-shrink: 0;
  display: flex; align-items: center; justify-content: center;
  font-size: 10px; font-weight: 800; color: #6366f1;
  background: conic-gradient(#6366f1 var(--phase-pct), #e5e7eb var(--phase-pct));
  position: relative;
}
.phase-status-ring::after {
  content: ''; position: absolute; width: 28px; height: 28px; border-radius: 50%; background: #fff;
}
.phase-status-ring span {
  position: relative; z-index: 1; font-size: 9px;
}
.phase-info { flex: 1; min-width: 0; }
.phase-name { font-size: 12px; font-weight: 700; color: #111; }
.phase-deadline {
  display: inline-block; padding: 1px 7px; border-radius: 4px; font-size: 8px; font-weight: 700;
  margin-left: 6px; background: #fef3c7; color: #92400e; border: 1px solid #fde68a;
}
.phase-deadline.phase-complete { background: #d1fae5; color: #065f46; border-color: #a7f3d0; }
.phase-scope {
  font-size: 9px; color: #666; margin-top: 3px; line-height: 1.4;
}
.phase-progress-bar {
  height: 4px; background: #e5e7eb; border-radius: 2px; margin: 8px 14px 4px; overflow: hidden;
}
.phase-progress-fill {
  height: 100%; border-radius: 2px; background: #6366f1; transition: width 0.3s;
}
.phase-deliverables { padding: 0 14px 12px; }
.deliv-item {
  display: flex; align-items: center; gap: 8px; padding: 5px 0;
  border-bottom: 1px solid #f5f5f5;
}
.deliv-item:last-child { border-bottom: none; }
.deliv-dot {
  width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
}
.deliv-dot-done { background: #22c55e; }
.deliv-dot-wip { background: #eab308; }
.deliv-dot-pending { background: #d1d5db; }
.deliv-info { flex: 1; min-width: 0; }
.deliv-name { font-size: 10px; font-weight: 600; color: #333; }
.deliv-name a {
  color: #4f46e5; text-decoration: none; border-bottom: 1px dashed #c7d2fe;
}
.deliv-name a:hover { color: #6366f1; border-bottom-color: #6366f1; }
.deliv-name .deliv-link-icon { font-size: 9px; color: #a5b4fc; margin-left: 3px; }
.deliv-desc { font-size: 8px; color: #999; margin-top: 1px; }
.deliv-bar {
  width: 50px; height: 4px; background: #e5e7eb; border-radius: 2px; overflow: hidden; flex-shrink: 0;
}
.deliv-bar-fill { height: 100%; border-radius: 2px; transition: width 0.3s; }
.deliv-bar-fill.db-done { background: #22c55e; }
.deliv-bar-fill.db-wip { background: #eab308; }
.deliv-bar-fill.db-pending { background: #d1d5db; }
.deliv-pct {
  font-size: 8px; font-weight: 700; width: 28px; text-align: right; flex-shrink: 0;
  color: #999;
}
.deliv-pct.dp-done { color: #16a34a; }
.deliv-pct.dp-wip { color: #b45309; }
.proj-section-title {
  font-size: 9px; font-weight: 800; text-transform: uppercase; letter-spacing: 1.2px;
  color: #999; margin: 16px 0 6px;
}
.proj-section-title:first-child { margin-top: 0; }
.proj-objective {
  font-size: 11px; color: #444; line-height: 1.7; margin-bottom: 4px;
}

/* Workflow items */
.wf-item {
  padding: 8px 10px; margin: 4px 0; border-radius: 7px; border: 1px solid #e8e8e8;
  background: #fafafa; cursor: default; transition: background 0.15s, border-color 0.15s;
  display: flex; align-items: flex-start; gap: 8px;
}
.wf-item:hover { background: #f0f0ff; border-color: #c7d2fe; }
.wf-content { flex: 1; min-width: 0; }
.wf-number {
  font-size: 10px; font-weight: 800; color: #6366f1; margin-right: 4px;
}
.wf-name { font-size: 11px; font-weight: 600; color: #333; }
.wf-fields-list {
  font-size: 8px; color: #999; margin-top: 3px;
  font-family: 'SF Mono', 'Fira Code', monospace; line-height: 1.5;
}
.wf-desc {
  font-size: 9px; color: #555; line-height: 1.5; margin-top: 3px; margin-bottom: 2px;
}

/* Workflow readiness dot */
.wf-status-dot {
  width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; margin-top: 5px;
}
.wf-dot-green { background: #22c55e; }
.wf-dot-yellow { background: #eab308; }
.wf-dot-red { background: #ef4444; }

/* Data readiness */
.data-readiness { margin-top: 6px; }
.readiness-bar-wrap {
  background: #e5e7eb; border-radius: 4px; height: 6px; margin: 4px 0; overflow: hidden;
}
.readiness-bar {
  height: 100%; border-radius: 4px; background: #22c55e; transition: width 0.3s;
}
.readiness-text { font-size: 9px; color: #555; font-weight: 600; }
.missing-src {
  display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 8px;
  font-weight: 600; background: #fef2f2; color: #dc2626; border: 1px solid #fecaca;
  margin: 2px 2px 2px 0;
}
.missing-src .mpos { font-weight: 800; color: #991b1b; }

/* Project timeline */
.proj-timeline {
  margin-top: 6px; padding: 6px 0;
}
.timeline-bar-wrap {
  position: relative; background: #e5e7eb; border-radius: 4px; height: 16px; overflow: hidden;
}
.timeline-segment {
  position: absolute; top: 0; height: 100%; transition: width 0.3s;
}
.timeline-done { background: #22c55e; left: 0; border-radius: 4px 0 0 4px; }
.timeline-pending { background: #fbbf24; border-radius: 0; }
.timeline-labels {
  display: flex; justify-content: space-between; margin-top: 3px;
}
.timeline-label { font-size: 7px; font-weight: 700; color: #999; text-transform: uppercase; }

/* Field gap section in project */
.gap-field {
  display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 8px;
  font-weight: 600; background: #f0fdf4; color: #16a34a; border: 1px solid #bbf7d0;
  margin: 2px 2px 2px 0;
  font-family: 'SF Mono', 'Fira Code', monospace;
}
.gap-unused {
  background: #f3f4f6; color: #9ca3af; border: 1px solid #e5e7eb;
}

/* Backlog panel */
.backlog-overlay {
  display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.15); z-index: 100;
}
.backlog-overlay.open { display: block; }
.backlog-panel {
  position: fixed; top: 50px; right: 24px; width: 420px;
  background: #fff; border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.15);
  z-index: 101; max-height: 80vh; overflow-y: auto;
  transform: translateY(-10px); opacity: 0; transition: transform 0.25s, opacity 0.25s;
}
.backlog-overlay.open .backlog-panel {
  transform: translateY(0); opacity: 1;
}
.backlog-header {
  padding: 14px 16px; border-bottom: 1px solid #eee;
  display: flex; justify-content: space-between; align-items: center;
}
.backlog-title { font-size: 13px; font-weight: 700; color: #111; }
.backlog-close {
  background: none; border: none; font-size: 18px; cursor: pointer; color: #999;
  width: 28px; height: 28px; border-radius: 6px; display: flex; align-items: center; justify-content: center;
}
.backlog-close:hover { background: #f3f4f6; color: #333; }
.backlog-list { padding: 8px 0; }
.backlog-item {
  display: flex; align-items: center; gap: 10px; padding: 8px 16px;
  border-bottom: 1px solid #f5f5f5;
}
.backlog-item:last-child { border-bottom: none; }
.backlog-rank {
  font-size: 11px; font-weight: 800; color: #6366f1; width: 22px; text-align: right; flex-shrink: 0;
}
.backlog-info { flex: 1; }
.backlog-name { font-size: 11px; font-weight: 600; color: #333; }
.backlog-eta { font-size: 9px; color: #888; margin-top: 1px; }
.backlog-unblocks {
  font-size: 8px; font-weight: 700; color: #6366f1; background: #eef2ff;
  padding: 1px 6px; border-radius: 8px; flex-shrink: 0;
}
.backlog-bar-wrap {
  width: 50px; height: 4px; background: #e5e7eb; border-radius: 2px; overflow: hidden; flex-shrink: 0;
}
.backlog-bar {
  height: 100%; border-radius: 2px; background: #6366f1;
}

/* Create project form */
.proj-form { padding: 0; }
.proj-form .form-group { margin-bottom: 10px; }
.proj-form label {
  display: block; font-size: 8px; font-weight: 700; text-transform: uppercase;
  letter-spacing: 0.8px; color: #999; margin-bottom: 3px;
}
.proj-form input[type="text"], .proj-form textarea {
  width: 100%; padding: 6px 8px; border: 1.5px solid #ddd; border-radius: 5px;
  font-size: 10px; font-family: inherit; color: #333; background: #fafafa;
  transition: border-color 0.15s;
}
.proj-form input:focus, .proj-form textarea:focus { outline: none; border-color: #6366f1; background: #fff; }
.proj-form textarea { resize: vertical; min-height: 50px; }
.type-toggle { display: flex; gap: 4px; }
.type-toggle-btn {
  padding: 4px 10px; border: 1.5px solid #ddd; border-radius: 5px;
  font-size: 9px; font-weight: 700; cursor: pointer; background: #fff; color: #666;
  transition: all 0.15s;
}
.type-toggle-btn.active { border-color: #6366f1; background: #eef2ff; color: #4f46e5; }
.wf-entry { display: flex; gap: 4px; align-items: center; margin-bottom: 4px; }
.wf-entry input { flex: 1; }
.wf-remove-btn {
  background: none; border: none; color: #dc2626; cursor: pointer; font-size: 14px;
  padding: 0 4px; font-weight: 700;
}
.add-wf-btn {
  padding: 3px 8px; border: 1px dashed #ccc; border-radius: 4px;
  background: none; cursor: pointer; font-size: 9px; color: #888; font-weight: 600;
}
.add-wf-btn:hover { border-color: #6366f1; color: #6366f1; }
.selected-fields-list { display: flex; flex-wrap: wrap; gap: 3px; margin-top: 4px; }
.sel-field-pill {
  display: inline-flex; align-items: center; gap: 3px;
  padding: 2px 6px; border-radius: 4px; font-size: 8px; font-weight: 600;
  background: #eef2ff; color: #4f46e5; border: 1px solid #c7d2fe;
  font-family: 'SF Mono', 'Fira Code', monospace;
}
.sel-field-pill .pill-x {
  cursor: pointer; font-weight: 800; color: #818cf8; margin-left: 2px;
}
.sel-field-pill .pill-x:hover { color: #dc2626; }
.form-auto-sources {
  font-size: 9px; color: #555; margin-top: 4px; line-height: 1.6;
}
.form-btns { display: flex; gap: 6px; margin-top: 10px; }
.btn-save, .btn-cancel {
  padding: 5px 14px; border-radius: 5px; font-size: 10px; font-weight: 700;
  cursor: pointer; border: none; transition: all 0.15s;
}
.btn-save { background: #6366f1; color: #fff; }
.btn-save:hover { background: #4f46e5; }
.btn-cancel { background: #f3f4f6; color: #666; }
.btn-cancel:hover { background: #e5e7eb; }

/* Project card clickable hint */
.proj-header { cursor: pointer; }
.proj-header:hover .proj-open-hint { color: #6366f1; }

/* SVG overlay */
svg.lines { position: absolute; top: 0; left: 0; pointer-events: none; z-index: 10; }

/* Hover dimming */
.pipeline.hov .src-item { opacity: 0.1; }
.pipeline.hov .sg-header { opacity: 0.25; }
.pipeline.hov .field { opacity: 0.1; }
.pipeline.hov .proj-box { opacity: 0.2; }
.pipeline.hov .lake-box { opacity: 0.35; }
.pipeline.hov .src-item.hl { opacity: 1; }
.pipeline.hov .sg-header.hl { opacity: 1; }
.pipeline.hov .field.hl { opacity: 1; transform: scale(1.08); z-index: 2; position: relative; }
.pipeline.hov .field.hl.selected { box-shadow: 0 0 0 2.5px #6366f1; }
.pipeline.hov .proj-box.hl { opacity: 1; }
.pipeline.hov .lake-box.hl { opacity: 1; box-shadow: 0 0 20px rgba(21,101,192,0.15); border-color: #90caf9; }

/* Insights panel (bottom bar) */
.insights-bar {
  display: none; background: #1e293b; color: #f8fafc; padding: 10px 24px;
  font-size: 10px; line-height: 1.6;
  border-top: 2px solid #334155;
}
.insights-bar.open { display: flex; gap: 24px; flex-wrap: wrap; align-items: center; }
.insight-stat {
  display: flex; align-items: center; gap: 6px;
}
.insight-num { font-size: 18px; font-weight: 800; color: #818cf8; }
.insight-label { font-size: 9px; color: #94a3b8; line-height: 1.3; }

/* Legend bar */
.legend-bar {
  display: none; padding: 6px 24px; background: #f8fafc; border-bottom: 1px solid #e5e7eb;
  font-size: 8px; color: #666; gap: 16px; align-items: center;
}
.legend-bar.open { display: flex; flex-wrap: wrap; }
.legend-item { display: flex; align-items: center; gap: 4px; }
.legend-dot {
  width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
}
</style>
</head>
<body>
<div class="header">
  <h1>Healthcare's Open Secret</h1>
  <p class="subtitle">Mapping the world of crazy healthcare data</p>
  <div class="status-controls">
    <button class="status-btn" id="btn-completed" onclick="toggleCompleted()">Completed</button>
    <button class="status-btn" id="btn-backlog" onclick="toggleBacklog()">Backlog</button>
    <button class="status-btn" id="btn-heatmap" onclick="toggleHeatmap()">Heatmap</button>
    <button class="status-btn" id="btn-risk" onclick="toggleRisk()">Risk</button>
    <button class="status-btn" id="btn-impact" onclick="toggleImpact()">Impact</button>
  </div>
</div>

<!-- Legend bar (shows contextual legend for active modes) -->
<div class="legend-bar" id="legend-bar"></div>

<!-- Backlog overlay -->
<div class="backlog-overlay" id="backlog-overlay" onclick="closeBacklog(event)">
  <div class="backlog-panel" id="backlog-panel">
    <div class="backlog-header">
      <span class="backlog-title">Integration Backlog</span>
      <button class="backlog-close" onclick="closeBacklog()">&times;</button>
    </div>
    <div class="backlog-list" id="backlog-list"></div>
  </div>
</div>

<!-- Source detail overlay -->
<div class="source-overlay" id="source-overlay">
  <div class="source-panel" id="source-panel"></div>
</div>

<!-- Project detail overlay -->
<div class="detail-overlay" id="detail-overlay">
  <div class="detail-panel" id="detail-panel"></div>
</div>

<div class="pipe-wrap" id="wrap">
<svg class="lines" id="svg"></svg>
<div class="pipeline" id="pipeline">

<!-- ===== SOURCES ===== -->
<div class="stage sources-stage">
  <div class="stage-label">Data Sources</div>

  <div class="source-group sg-gov">
    <div class="sg-header">Government &amp; Registry</div>
    <div class="src-item" data-id="nppes" data-effort="low"><span class="sn">NPPES</span><span class="src-status-badge">&#10003;</span><span class="src-effort effort-low"></span><span class="sm m-csv">CSV</span></div>
    <div class="src-item" data-id="pecos" data-effort="low"><span class="sn">CMS PECOS</span><span class="src-status-badge">&#10003;</span><span class="src-effort effort-low"></span><span class="sm m-csv">CSV</span></div>
    <div class="src-item" data-id="pos" data-effort="low"><span class="sn">CMS Provider of Services</span><span class="src-status-badge">&#10003;</span><span class="src-effort effort-low"></span><span class="sm m-csv">CSV</span></div>
    <div class="src-item" data-id="clia" data-effort="low"><span class="sn">CMS CLIA Labs</span><span class="src-status-badge">&#10003;</span><span class="src-effort effort-low"></span><span class="sm m-csv">CSV</span></div>
    <div class="src-item" data-id="hrsa" data-effort="med"><span class="sn">HRSA FQHC</span><span class="src-status-badge">&#10003;</span><span class="src-effort effort-med"></span><span class="sm m-api">API</span></div>
    <div class="src-item" data-id="hpsa_mua" data-effort="low"><span class="sn">HRSA HPSA / MUA</span><span class="src-status-badge">&#10003;</span><span class="src-effort effort-low"></span><span class="sm m-csv">CSV</span></div>
    <div class="src-item" data-id="ruca" data-effort="low"><span class="sn">USDA RUCA Codes</span><span class="src-status-badge">&#10003;</span><span class="src-effort effort-low"></span><span class="sm m-csv">CSV</span></div>
    <div class="src-item" data-id="census_ua" data-effort="low"><span class="sn">Census Urban Areas</span><span class="src-status-badge">&#10003;</span><span class="src-effort effort-low"></span><span class="sm m-csv">SHP</span></div>
  </div>

  <div class="source-group sg-cost">
    <div class="sg-header">Cost &amp; Utilization</div>
    <div class="src-item" data-id="medicare_util" data-effort="med"><span class="sn">Medicare Util &amp; Payment</span><span class="src-status-badge">&#10003;</span><span class="src-effort effort-med"></span><span class="sm m-api">API</span></div>
    <div class="src-item" data-id="tic" data-effort="med"><span class="sn">TiC Files</span><span class="src-status-badge">&#10003;</span><span class="src-effort effort-med"></span><span class="sm m-json">JSON</span></div>
    <div class="src-item" data-id="fair_health" data-effort="high"><span class="sn">FAIR Health</span><span class="src-status-badge">&#10003;</span><span class="src-effort effort-high"></span><span class="sm m-api">API</span></div>
    <div class="src-item" data-id="meps" data-effort="low"><span class="sn">MEPS</span><span class="src-status-badge">&#10003;</span><span class="src-effort effort-low"></span><span class="sm m-csv">CSV</span></div>
    <div class="src-item" data-id="rand" data-effort="high"><span class="sn">RAND / Sage</span><span class="src-status-badge">&#10003;</span><span class="src-effort effort-high"></span><span class="sm m-api">API</span></div>
  </div>

  <div class="source-group sg-quality">
    <div class="sg-header">Quality &amp; Safety</div>
    <div class="src-item" data-id="mips" data-effort="med"><span class="sn">MIPS / QPP</span><span class="src-status-badge">&#10003;</span><span class="src-effort effort-med"></span><span class="sm m-api">API</span></div>
    <div class="src-item" data-id="care_compare" data-effort="med"><span class="sn">CMS Care Compare</span><span class="src-status-badge">&#10003;</span><span class="src-effort effort-med"></span><span class="sm m-api">API</span></div>
    <div class="src-item" data-id="leapfrog" data-effort="high"><span class="sn">Leapfrog Safety</span><span class="src-status-badge">&#10003;</span><span class="src-effort effort-high"></span><span class="sm m-scraper">SCRAPER</span></div>
    <div class="src-item" data-id="med_boards" data-effort="high"><span class="sn">State Medical Boards</span><span class="src-status-badge">&#10003;</span><span class="src-effort effort-high"></span><span class="sm m-scraper">SCRAPER</span></div>
  </div>

  <div class="source-group sg-web">
    <div class="sg-header">Web &amp; Public</div>
    <div class="src-item" data-id="website" data-effort="high"><span class="sn">Practice Websites</span><span class="src-status-badge">&#10003;</span><span class="src-effort effort-high"></span><span class="sm m-scraper">SCRAPER</span></div>
    <div class="src-item" data-id="google" data-effort="med"><span class="sn">Google Business</span><span class="src-status-badge">&#10003;</span><span class="src-effort effort-med"></span><span class="sm m-api">API</span></div>
    <div class="src-item" data-id="healthgrades" data-effort="high"><span class="sn">Healthgrades / Vitals</span><span class="src-status-badge">&#10003;</span><span class="src-effort effort-high"></span><span class="sm m-scraper">SCRAPER</span></div>
    <div class="src-item" data-id="linkedin" data-effort="vhigh"><span class="sn">LinkedIn</span><span class="src-status-badge">&#10003;</span><span class="src-effort effort-vhigh"></span><span class="sm m-scraper">SCRAPER</span></div>
    <div class="src-item" data-id="sos" data-effort="high"><span class="sn">SEC / State SoS</span><span class="src-status-badge">&#10003;</span><span class="src-effort effort-high"></span><span class="sm m-scraper">SCRAPER</span></div>
  </div>

  <div class="source-group sg-employer">
    <div class="sg-header">Employer &amp; Market</div>
    <div class="src-item" data-id="form5500" data-effort="low"><span class="sn">DOL Form 5500</span><span class="src-status-badge">&#10003;</span><span class="src-effort effort-low"></span><span class="sm m-csv">CSV</span></div>
    <div class="src-item" data-id="gao" data-effort="high"><span class="sn">GAO Market Conc.</span><span class="src-status-badge">&#10003;</span><span class="src-effort effort-high"></span><span class="sm m-scraper">SCRAPER</span></div>
  </div>

  <div class="source-group sg-legal">
    <div class="sg-header">Legal &amp; Regulatory</div>
    <div class="src-item" data-id="aks" data-effort="med"><span class="sn">Anti-Kickback (AKS)</span><span class="src-status-badge">&#10003;</span><span class="src-effort effort-med"></span><span class="sm m-legal">LAW</span></div>
    <div class="src-item" data-id="stark" data-effort="med"><span class="sn">Stark Law</span><span class="src-status-badge">&#10003;</span><span class="src-effort effort-med"></span><span class="sm m-legal">LAW</span></div>
    <div class="src-item" data-id="erisa" data-effort="med"><span class="sn">ERISA</span><span class="src-status-badge">&#10003;</span><span class="src-effort effort-med"></span><span class="sm m-legal">LAW</span></div>
    <div class="src-item" data-id="vbc_safe_harbors" data-effort="med"><span class="sn">Value-Based Safe Harbors</span><span class="src-status-badge">&#10003;</span><span class="src-effort effort-med"></span><span class="sm m-legal">LAW</span></div>
    <div class="src-item" data-id="ftc_cin" data-effort="med"><span class="sn">FTC/DOJ CIN Guidelines</span><span class="src-status-badge">&#10003;</span><span class="src-effort effort-med"></span><span class="sm m-legal">LAW</span></div>
    <div class="src-item state-law-row" data-id="state_law" data-effort="high" id="state-law-row">
      <div class="state-law-toggle" onclick="toggleStateLaw(event)">
        <span class="sn">State Law</span>
        <span class="src-status-badge">&#10003;</span>
        <span class="src-effort effort-high"></span>
        <span class="state-law-badge" id="state-law-badge">1 state</span>
        <span class="state-law-expand-icon">&#8250;</span>
      </div>
      <div class="state-law-children" id="state-law-children"></div>
    </div>
  </div>

  <div class="source-group sg-ai">
    <div class="sg-header">AI &amp; Derived</div>
    <div class="src-item" data-id="ai_classifier" data-effort="vhigh"><span class="sn">AI Independence Classifier</span><span class="src-status-badge">&#10003;</span><span class="src-effort effort-vhigh"></span><span class="sm m-agent">AI</span></div>
    <div class="src-item" data-id="pe_list" data-effort="low"><span class="sn">Known PE Platforms</span><span class="src-status-badge">&#10003;</span><span class="src-effort effort-low"></span><span class="sm m-curated">CURATED</span></div>
    <div class="src-item" data-id="derived" data-effort="med"><span class="sn">Derived / Calculated</span><span class="src-status-badge">&#10003;</span><span class="src-effort effort-med"></span><span class="sm m-derived">DERIVED</span></div>
  </div>
</div>

<!-- Arrow -->
<div class="flow-arrow"><span class="arr">›</span></div>

<!-- ===== DATA LAKE ===== -->
<div class="stage lake-stage">
  <div class="stage-label">Ingestion</div>
  <div class="lake-box" id="lake">
    <div class="lake-title">AWS S3<br>Data Lake</div>
    <div class="lake-fmt">CSV</div>
    <div class="lake-fmt">JSON</div>
    <div class="lake-fmt">API</div>
    <div class="lake-fmt">Scraper</div>
    <div class="lake-fmt">AI Agent</div>
  </div>
</div>

<!-- Arrow -->
<div class="flow-arrow"><span class="arr">›</span></div>

<!-- ===== DATA WAREHOUSE ===== -->
<div class="stage warehouse-stage">
  <div class="stage-label">Practice Intelligence Record</div>
  <div class="wh-box" id="warehouse">
    <div class="fsec">
      <div class="fsec-label">Identity</div>
      <div class="frow">
        <div class="field f-identity" data-name="practice_name" data-sources="nppes">practice_name<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
        <div class="field f-identity" data-name="npi" data-sources="nppes">npi<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
        <div class="field f-identity" data-name="address" data-sources="nppes">address<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
        <div class="field f-identity" data-name="phone" data-sources="nppes">phone<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
        <div class="field f-identity" data-name="specialty" data-sources="nppes">specialty<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
        <div class="field f-identity" data-name="taxonomy_code" data-sources="nppes">taxonomy_code<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
        <div class="field f-identity" data-name="website_url" data-sources="website">website_url<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
        <div class="field f-identity" data-name="legal_entity_name" data-sources="website,sos">legal_entity_name<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
      </div>
    </div>
    <div class="fsec">
      <div class="fsec-label">Roster</div>
      <div class="frow">
        <div class="field f-roster" data-name="providers" data-sources="nppes,pecos">providers[]<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
        <div class="field f-roster" data-name="provider_count" data-sources="nppes,pecos">provider_count<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
        <div class="field f-roster" data-name="credentials" data-sources="pecos">credentials<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
        <div class="field f-roster" data-name="reassignment_org" data-sources="pecos">reassignment_org<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
      </div>
    </div>
    <div class="fsec">
      <div class="fsec-label">Independence</div>
      <div class="frow">
        <div class="field f-independence" data-name="ownership_type" data-sources="ai_classifier">ownership_type<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
        <div class="field f-independence" data-name="parent_entity" data-sources="ai_classifier">parent_entity<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
        <div class="field f-independence" data-name="independence_confidence" data-sources="ai_classifier">independence_confidence<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
        <div class="field f-independence" data-name="pe_platform_match" data-sources="pe_list">pe_platform_match<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
        <div class="field f-independence" data-name="facility_type_flag" data-sources="pos">facility_type_flag<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
        <div class="field f-independence" data-name="fqhc_flag" data-sources="hrsa">fqhc_flag<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
      </div>
    </div>
    <div class="fsec">
      <div class="fsec-label">Rural &amp; Shortage</div>
      <div class="frow">
        <div class="field f-rural" data-name="ruca_code" data-sources="ruca">ruca_code<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
        <div class="field f-rural" data-name="rurality_tier" data-sources="ruca,census_ua">rurality_tier<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
        <div class="field f-rural" data-name="hpsa_flag" data-sources="hpsa_mua">hpsa_flag<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
        <div class="field f-rural" data-name="mua_flag" data-sources="hpsa_mua">mua_flag<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
        <div class="field f-rural" data-name="hpsa_score" data-sources="hpsa_mua">hpsa_score<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
        <div class="field f-rural" data-name="clia_status" data-sources="clia">clia_status<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
        <div class="field f-rural" data-name="clia_cert_type" data-sources="clia">clia_cert_type<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
        <div class="field f-rural" data-name="dual_eligible_pct" data-sources="medicare_util">dual_eligible_pct<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
        <div class="field f-rural" data-name="rhc_eligibility_score" data-sources="derived">rhc_eligibility_score<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
      </div>
    </div>
    <div class="fsec">
      <div class="fsec-label">Technology</div>
      <div class="frow">
        <div class="field f-technology" data-name="ehr_system" data-sources="website">ehr_system<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
        <div class="field f-technology" data-name="scheduling_platform" data-sources="website">scheduling_platform<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
        <div class="field f-technology" data-name="telehealth_available" data-sources="website">telehealth_available<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
        <div class="field f-technology" data-name="accepted_insurances" data-sources="website">accepted_insurances[]<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
      </div>
    </div>
    <div class="fsec">
      <div class="fsec-label">Services</div>
      <div class="frow">
        <div class="field f-services" data-name="cpt_codes" data-sources="medicare_util,tic">cpt_codes[]<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
        <div class="field f-services" data-name="medicare_service_count" data-sources="medicare_util">medicare_service_count<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
        <div class="field f-services" data-name="medicare_beneficiary_count" data-sources="medicare_util">medicare_beneficiary_count<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
      </div>
    </div>
    <div class="fsec">
      <div class="fsec-label">Revenue</div>
      <div class="frow">
        <div class="field f-revenue" data-name="medicare_volume_by_cpt" data-sources="medicare_util">medicare_volume_by_cpt<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
        <div class="field f-revenue" data-name="medicare_allowed_amt" data-sources="medicare_util">medicare_allowed_amt<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
        <div class="field f-revenue" data-name="commercial_rates_by_payer" data-sources="tic">commercial_rates_by_payer<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
        <div class="field f-revenue" data-name="payer_mix_estimate" data-sources="meps">payer_mix_estimate<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
        <div class="field f-revenue" data-name="est_annual_revenue" data-sources="derived">est_annual_revenue<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
        <div class="field f-revenue" data-name="fair_health_benchmark" data-sources="fair_health">fair_health_benchmark<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
      </div>
    </div>
    <div class="fsec">
      <div class="fsec-label">Quality</div>
      <div class="frow">
        <div class="field f-quality" data-name="mips_quality_score" data-sources="mips">mips_quality_score<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
        <div class="field f-quality" data-name="mips_cost_score" data-sources="mips">mips_cost_score<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
        <div class="field f-quality" data-name="facility_quality" data-sources="care_compare">facility_quality<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
        <div class="field f-quality" data-name="leapfrog_grade" data-sources="leapfrog">leapfrog_grade<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
        <div class="field f-quality" data-name="hac_penalty_flag" data-sources="care_compare">hac_penalty_flag<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
        <div class="field f-quality" data-name="board_certifications" data-sources="website,med_boards">board_certifications[]<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
        <div class="field f-quality" data-name="accreditations" data-sources="website">accreditations[]<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
        <div class="field f-quality" data-name="composite_quality_tier" data-sources="derived">composite_quality_tier<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
      </div>
    </div>
    <div class="fsec">
      <div class="fsec-label">Patient Satisfaction</div>
      <div class="frow">
        <div class="field f-satisfaction" data-name="google_rating" data-sources="google">google_rating<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
        <div class="field f-satisfaction" data-name="review_count" data-sources="google">review_count<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
        <div class="field f-satisfaction" data-name="review_sentiment" data-sources="google,ai_classifier">review_sentiment<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
        <div class="field f-satisfaction" data-name="healthgrades_rating" data-sources="healthgrades">healthgrades_rating<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
      </div>
    </div>
    <div class="fsec">
      <div class="fsec-label">Market Comparison</div>
      <div class="frow">
        <div class="field f-comparison" data-name="cost_delta_vs_hospital" data-sources="derived">cost_delta_vs_hospital<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
        <div class="field f-comparison" data-name="quality_delta" data-sources="derived">quality_delta<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
        <div class="field f-comparison" data-name="regional_markup_pct" data-sources="rand">regional_markup_pct<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
        <div class="field f-comparison" data-name="opportunity_score" data-sources="derived">opportunity_score<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
      </div>
    </div>
    <div class="fsec">
      <div class="fsec-label">Employer</div>
      <div class="frow">
        <div class="field f-employer" data-name="nearby_employers" data-sources="form5500">nearby_employers[]<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
        <div class="field f-employer" data-name="employer_benefit_cost" data-sources="form5500">employer_benefit_cost<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
        <div class="field f-employer" data-name="market_concentration" data-sources="gao">market_concentration<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
        <div class="field f-employer" data-name="decision_makers" data-sources="linkedin">decision_makers[]<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
        <div class="field f-employer" data-name="est_overpayment" data-sources="derived">est_overpayment<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
        <div class="field f-employer" data-name="savings_pitch" data-sources="derived">savings_pitch<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
      </div>
    </div>
    <div class="fsec">
      <div class="fsec-label">Legal &amp; Compliance</div>
      <div class="frow">
        <div class="field f-legal" data-name="aks_safe_harbor_flags" data-sources="aks,vbc_safe_harbors">aks_safe_harbor_flags<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
        <div class="field f-legal" data-name="stark_exception_flags" data-sources="stark,vbc_safe_harbors">stark_exception_flags<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
        <div class="field f-legal" data-name="cin_eligibility" data-sources="ftc_cin">cin_eligibility<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
        <div class="field f-legal" data-name="erisa_plan_type" data-sources="erisa,form5500">erisa_plan_type<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
        <div class="field f-legal" data-name="state_compliance_flags" data-sources="state_law">state_compliance_flags<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
        <div class="field f-legal" data-name="tpa_requirements" data-sources="state_law,erisa">tpa_requirements<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
        <div class="field f-legal" data-name="contract_template_id" data-sources="derived">contract_template_id<span class="heat-dot"></span><span class="risk-dot"></span><span class="field-tooltip"></span></div>
      </div>
    </div>
  </div>
</div>

<!-- Arrow -->
<div class="flow-arrow"><span class="arr">›</span></div>

<!-- ===== PROJECTS ===== -->
<div class="stage projects-stage" id="projects-stage">
  <div class="stage-label">Products</div>
  <div id="projects-container"></div>
</div>

</div><!-- /pipeline -->
</div><!-- /pipe-wrap -->

<!-- Insights bar -->
<div class="insights-bar" id="insights-bar"></div>
<div style="position:fixed;bottom:0;left:0;right:0;background:#1e293b;padding:6px 24px;display:flex;justify-content:flex-end;z-index:50;"><span style="color:#fff;font-size:10px;font-weight:600;letter-spacing:0.3px;">urgent + fun :)</span></div>

<script>
const wrap = document.getElementById('wrap');
const pipeline = document.getElementById('pipeline');
const svg = document.getElementById('svg');
const lake = document.getElementById('lake');

const SRC_COLORS = {
  nppes:'#5c7cfa', pecos:'#5c7cfa', pos:'#5c7cfa', hrsa:'#5c7cfa',
  medicare_util:'#37b24d', tic:'#37b24d', fair_health:'#37b24d', meps:'#37b24d', rand:'#37b24d',
  mips:'#f59f00', care_compare:'#f59f00', leapfrog:'#f59f00', med_boards:'#f59f00',
  website:'#e8590c', google:'#e8590c', healthgrades:'#e8590c', linkedin:'#e8590c', sos:'#e8590c',
  form5500:'#ae3ec9', gao:'#ae3ec9',
  ai_classifier:'#e03131', pe_list:'#868e96', derived:'#be4bdb'
};

// ── Data Model ──

const COMPLETED_SOURCES = new Set([
  'nppes','pecos','pos','clia','medicare_util','mips','care_compare','hrsa','hpsa_mua','ruca','census_ua','meps','pe_list','derived',
  'aks','stark','erisa','vbc_safe_harbors','ftc_cin','state_law'
]);

const BACKLOG = [
  { id:'tic', name:'TiC Files', eta:'Q2 2025' },
  { id:'fair_health', name:'FAIR Health', eta:'Q2 2025' },
  { id:'website', name:'Practice Websites', eta:'Q3 2025' },
  { id:'google', name:'Google Business', eta:'Q3 2025' },
  { id:'form5500', name:'DOL Form 5500', eta:'Q3 2025' },
  { id:'ai_classifier', name:'AI Independence Classifier', eta:'Q4 2025' },
  { id:'leapfrog', name:'Leapfrog Safety', eta:'Q4 2025' },
  { id:'healthgrades', name:'Healthgrades', eta:'Q4 2025' },
  { id:'linkedin', name:'LinkedIn', eta:'Q1 2026' },
  { id:'sos', name:'SEC / State SoS', eta:'Q1 2026' },
  { id:'med_boards', name:'State Medical Boards', eta:'Q1 2026' },
  { id:'gao', name:'GAO Market Conc.', eta:'Q2 2026' },
  { id:'rand', name:'RAND / Sage', eta:'Q2 2026' },
];

const ETA_ORDER = ['Q2 2025','Q3 2025','Q4 2025','Q1 2026','Q2 2026'];

const PROJECTS = [
  {
    id: 'proj-dcm',
    name: 'Direct Contracting Marketplace',
    type: 'external',
    owner: 'Alex Barrett',
    shortDesc: 'Market-making platform enabling direct contracting between independent medical practices and self-insured employers — bypassing traditional insurance networks. Proves independent practices deliver equal or better care at lower cost, makes it transactable with standardized pricing, and runs AI agents for legal/admin scaffolding.',
    objective: 'Meroka is a market-making platform that enables direct contracting between independent medical practices and self-insured employers — bypassing traditional insurance networks. The core thesis: independent practices deliver equal or better care at significantly lower cost than hospital-affiliated and PE-owned practices, but lack the infrastructure to contract directly with employers. Meroka provides that infrastructure by proving the gap (comprehensive cost/quality dataset), making it transactable (standardized pricing derived from data, automated legal scaffolding including CIN formation and direct employer contracts), and running AI agents that handle administrative work previously requiring teams of lawyers and RCM specialists.',
    workflows: [
      {
        name: 'L1: Provider Map',
        desc: 'Identify every independent practice, classify ownership via NPPES + PECOS + web scraping. Output: providers table + practice_profiles with independence classification.',
        fields: ['practice_name','npi','address','phone','specialty','taxonomy_code','website_url','legal_entity_name','providers','provider_count','credentials','reassignment_org','ownership_type','parent_entity','independence_confidence','pe_platform_match','facility_type_flag','fqhc_flag','ehr_system','scheduling_platform','telehealth_available','accepted_insurances','board_certifications','accreditations']
      },
      {
        name: 'L2: Services & Revenue',
        desc: 'What each practice does, how much, and what they get paid — Medicare utilization + TiC negotiated rates from UHC, BCBS MA, Aetna. Target CPTs: office visits, MRI, arthroscopy, PT, joint injection, total joint replacement.',
        fields: ['cpt_codes','medicare_service_count','medicare_beneficiary_count','medicare_volume_by_cpt','medicare_allowed_amt','commercial_rates_by_payer','payer_mix_estimate','est_annual_revenue','fair_health_benchmark']
      },
      {
        name: 'L3: Quality Signals',
        desc: 'Attach quality and patient satisfaction to each practice — MIPS scores, CMS Care Compare, Google Business ratings, state medical board license status.',
        fields: ['mips_quality_score','mips_cost_score','facility_quality','leapfrog_grade','hac_penalty_flag','board_certifications','accreditations','composite_quality_tier','google_rating','review_count','review_sentiment','healthgrades_rating']
      },
      {
        name: 'L4: Comparison Engine',
        desc: 'Prove independents deliver equal or better care at lower cost. Segment by independence status, calculate avg negotiated rate, Medicare allowed, MIPS, Google rating per CPT. Generate headline stats for employer pitch.',
        fields: ['ownership_type','independence_confidence','cost_delta_vs_hospital','quality_delta','regional_markup_pct','opportunity_score','commercial_rates_by_payer','medicare_allowed_amt','mips_quality_score','google_rating']
      },
      {
        name: 'L5: Employer Contracting & Legal Agent',
        desc: 'Given an employer and qualified independent practices, auto-generate CIN formation docs, direct employer-provider contracts with standardized pricing, TPA coordination memos, and DocuSign-ready approval bundles. Grounded in AKS safe harbors, Stark exceptions, ERISA requirements, FTC CIN guidelines, and state-specific compliance rules.',
        fields: ['nearby_employers','employer_benefit_cost','market_concentration','decision_makers','est_overpayment','savings_pitch','aks_safe_harbor_flags','stark_exception_flags','cin_eligibility','erisa_plan_type','state_compliance_flags','tpa_requirements','contract_template_id']
      }
    ],
    phases: [
      {
        name: 'MA Sports Medicine POC',
        status: 'active',
        deadline: 'Feb 28, 2026',
        desc: 'Full 5-layer pipeline for Massachusetts sports medicine only. ~200 practices, 6 taxonomy codes, 15 target CPTs. Proves the thesis with real data for one specialty in one state.',
        deliverables: [
          { name: 'Provider Map (NPPES)', desc: 'All MA sports medicine providers from NPPES filtered by taxonomy', status: 'done', pct: 100, url: null },
          { name: 'PECOS Enrollment', desc: 'Group affiliations and reassignment relationships', status: 'wip', pct: 60, url: null },
          { name: 'Practice Profiles', desc: 'Web-scraped independence classification via Claude', status: 'wip', pct: 40, url: null },
          { name: 'Medicare Utilization', desc: 'Medicare payment data for MA target CPTs', status: 'done', pct: 100, url: null },
          { name: 'TiC Negotiated Rates', desc: 'Rates from UHC, BCBS MA, Aetna for 15 CPTs', status: 'wip', pct: 25, url: null },
          { name: 'MIPS Quality Scores', desc: 'QPP quality/cost scores for MA providers', status: 'wip', pct: 30, url: null },
          { name: 'Google Reviews', desc: 'Star ratings and review counts per practice', status: 'wip', pct: 20, url: null },
          { name: 'Comparison Table', desc: 'provider_comparison_v2 — master join of all 5 layers', status: 'pending', pct: 0, url: null },
          { name: 'Streamlit Dashboard', desc: 'Visual exploration of MA sports med data', status: 'wip', pct: 50, url: 'http://localhost:8501' },
          { name: 'CFO Insights Report', desc: 'One-pager with real numbers for employer pitch', status: 'pending', pct: 0, url: null },
          { name: 'Legal Agent Draft', desc: 'CIN formation doc + direct employer contract template', status: 'pending', pct: 0, url: null }
        ]
      },
      {
        name: 'MA Full Specialty Expansion',
        status: 'planned',
        deadline: 'Q2 2026',
        desc: 'Expand from sports medicine to all independent practice specialties in Massachusetts. Same 5-layer architecture, broader taxonomy codes and CPT coverage.',
        deliverables: [
          { name: 'Taxonomy Expansion', desc: 'Add primary care, dermatology, cardiology, etc.', status: 'pending', pct: 0, url: null },
          { name: 'TiC Rate Coverage', desc: 'Full CPT catalog across all payers', status: 'pending', pct: 0, url: null },
          { name: 'Employer Targeting', desc: 'DOL Form 5500 data for MA self-funded employers', status: 'pending', pct: 0, url: null },
          { name: 'Multi-specialty Dashboard', desc: 'Expanded Streamlit with specialty filters', status: 'pending', pct: 0, url: null }
        ]
      },
      {
        name: 'Multi-state Rollout',
        status: 'planned',
        deadline: 'Q3 2026',
        desc: 'Replicate the Massachusetts pipeline to additional states. Start with CT, NY, NJ — high concentration of self-funded employers.',
        deliverables: [
          { name: 'State Pipeline Template', desc: 'Parameterized pipeline that takes state as input', status: 'pending', pct: 0, url: null },
          { name: 'CT + NY + NJ Deployment', desc: 'Run full 5-layer pipeline for 3 new states', status: 'pending', pct: 0, url: null },
          { name: 'Cross-state Comparison', desc: 'National benchmark pricing by CPT and independence status', status: 'pending', pct: 0, url: null }
        ]
      }
    ],
    architecture: {
      nodes: [
        { id:'phone', type:'interface', icon:'P', name:'Phone (Telegram)', desc:'Send instructions, receive status updates', cost:'Free' },
        { id:'mac', type:'compute', icon:'M', name:'Mac Mini M4', desc:'Always-on local compute — runs pipelines and agents overnight',
          children:['OpenClaw agent','Python 3.14 pipelines','Telegram bot','Brave (scraping)'],
          detail:'~/meroka/ — scripts/, data/ (temp), logs/, outputs/, credentials/' },
        { id:'claude', type:'ai', icon:'C', name:'Claude Sonnet (Anthropic API)', desc:'Reasoning brain — web scrape classification, insights reports, legal drafting', cost:'$5-30/wk' },
        { id:'openclaw', type:'ai', icon:'O', name:'OpenClaw Agent Framework', desc:'Gives Claude ability to browse, run code, read/write files. Gateway on port 18789, Brave relay on 18792.', cost:'Free' },
        { id:'bigquery', type:'storage', icon:'B', name:'Google BigQuery', desc:'meroka-massachusetts.sports_medicine — serverless cloud warehouse', cost:'<$1/wk',
          tables:[
            { name:'providers', status:'done', desc:'MA sports medicine from NPPES' },
            { name:'practice_profiles', status:'wip', desc:'Web-scraped independence classification' },
            { name:'medicare_utilization', status:'done', desc:'Medicare payment data for MA' },
            { name:'tic_rates', status:'wip', desc:'Negotiated rates (UHC, BCBS MA, Aetna)' },
            { name:'mips_scores', status:'wip', desc:'MIPS quality scores' },
            { name:'practice_reviews', status:'wip', desc:'Google ratings & reviews' },
            { name:'pecos_enrollment', status:'wip', desc:'Group affiliations' },
            { name:'provider_comparison_v2', status:'pending', desc:'Master join — all layers' }
          ]
        },
        { id:'output', type:'output', icon:'D', name:'Outputs', desc:'Streamlit dashboard (localhost:8501), CFO insights reports, CIN formation docs, employer contracts' }
      ],
      flows: [
        { from:'phone', to:'mac', label:'Telegram API' },
        { from:'mac', to:'claude', label:'Anthropic API' },
        { from:'mac', to:'bigquery', label:'BigQuery SDK' },
        { from:'bigquery', to:'output', label:'SQL queries' }
      ]
    },
    affiliations: [
      { tier: 'Research & Data Credibility', items: [
        { name: 'Massachusetts Medical Society', status: 'target', why: 'Publishes the New England Journal of Medicine. An MA-based partnership on your POC data is the closest parallel to Open Evidence\'s playbook.', contact: 'Partnership inquiries: partnerships@mms.org | Main: https://www.massmed.org | 860 Winter St, Waltham, MA 02451 | (781) 434-7000' },
        { name: 'Harvard T.H. Chan School of Public Health', status: 'target', why: 'Health economics faculty already study independent vs. system pricing. Affiliation means your data model has academic rigor.', contact: 'Health Policy & Management dept: https://www.hsph.harvard.edu/health-policy-and-management/ | Research partnerships: https://www.hsph.harvard.edu/research/ | (617) 432-1000' },
        { name: 'Dartmouth Institute for Health Policy', status: 'target', why: 'Pioneers of healthcare variation research. Their brand says "this data is methodologically sound."', contact: 'https://tdi.dartmouth.edu | Research inquiries: tdi@dartmouth.edu | (603) 646-6674' },
        { name: 'RAND Corporation', status: 'target', why: 'Already publishes hospital pricing study (commercial = 254% of Medicare). If RAND validated your independent practice pricing data, instant authority.', contact: 'Health Care program: https://www.rand.org/health.html | Media: media@rand.org | (310) 393-0411' },
        { name: 'Commonwealth Fund', status: 'target', why: 'Publishes market concentration analysis. Would amplify the consolidation angle.', contact: 'https://www.commonwealthfund.org | info@cmwf.org | (212) 606-3800' }
      ]},
      { tier: 'Independent Practice Advocacy', items: [
        { name: 'American Medical Association (AMA)', status: 'target', why: 'Actively advocates against consolidation, publishes physician practice benchmarking. AMA endorsement = every independent doc pays attention.', contact: 'Practice transformation: https://www.ama-assn.org/practice-management | Partnerships: https://www.ama-assn.org/about/partnerships | (800) 621-8335' },
        { name: 'Physicians Advocacy Institute', status: 'target', why: 'Literally tracks physician practice acquisitions by hospitals and PE. Your data feeds their mission directly.', contact: 'https://www.physiciansadvocacyinstitute.org | info@physadvocacy.org' },
        { name: 'AOSSM (Sports Medicine)', status: 'target', why: 'American Orthopaedic Society for Sports Medicine — your POC is sports medicine. If they co-sign your data, every sports med practice sees it.', contact: 'https://www.sportsmed.org | aossm@aossm.org | (847) 292-4900 | 9400 W. Higgins Rd, Suite 300, Rosemont, IL 60018' }
      ]},
      { tier: 'Employer & Purchaser Groups', items: [
        { name: 'National Alliance of Healthcare Purchaser Coalitions', status: 'target', why: 'Represents the self-insured employers you\'re selling to. Their endorsement = "employers trust this data."', contact: 'https://www.nationalalliancehealth.org | info@nationalalliancehealth.org | (202) 775-9300' },
        { name: 'Employers\' Forum of Indiana', status: 'target', why: 'Funded the RAND hospital pricing study. Already bought in on price transparency for employers.', contact: 'https://employersforum.org | Employer PTP project: https://employerptp.org | info@employersforum.org' },
        { name: 'Leapfrog Group', status: 'target', why: 'Employer-driven quality transparency. Validates your quality signals layer (L3).', contact: 'https://www.leapfroggroup.org | info@leapfroggroup.org | (202) 292-6713' },
        { name: 'Pacific Business Group on Health', status: 'target', why: 'Large employer coalition, aggressive on direct contracting and VBC arrangements.', contact: 'https://www.pbgh.org | info@pbgh.org | (415) 281-8660' }
      ]},
      { tier: 'Policy & Quality Validation', items: [
        { name: 'MA Health Policy Commission', status: 'target', why: 'Already publishes MA cost/quality data. A partnership on your MA POC would be natural — mutual interest.', contact: 'https://www.mass.gov/orgs/health-policy-commission | HPC.Inquiries@mass.gov | (617) 979-1400' },
        { name: 'NCQA', status: 'target', why: 'If your composite quality tier methodology was NCQA-reviewed, that\'s a stamp of approval on your quality layer.', contact: 'https://www.ncqa.org | customersupport@ncqa.org | (888) 275-7585' },
        { name: 'MedPAC', status: 'target', why: 'If they cited your data in their annual report to Congress — gold standard for policy influence.', contact: 'https://www.medpac.gov | (202) 220-3700 | 425 I Street NW, Suite 701, Washington DC 20001' }
      ]}
    ],
    get allFields() {
      const s = new Set();
      this.workflows.forEach(w => w.fields.forEach(f => s.add(f)));
      return Array.from(s);
    }
  },
  {
    id: 'proj-malpha',
    name: 'Malpha',
    type: 'internal',
    owner: 'Othmane',
    shortDesc: 'Coming soon',
    objective: '',
    workflows: [],
    get allFields() { return []; }
  },
  {
    id: 'proj-rhc',
    name: 'Rural Health Classifier',
    type: 'external',
    owner: 'Bonnie',
    shortDesc: 'Classify practices by Rural Health Clinic (RHC) eligibility — geographic rurality via RUCA/Census, HPSA/MUA shortage area status, CLIA lab certification, and Medicare/Medicaid payer mix — to identify practices that qualify for RHC designation and its enhanced reimbursement.',
    objective: 'CMS defines RHC eligibility as: (1) located in a non-urbanized area (Census), (2) within a Health Professional Shortage Area or Medically Underserved Area (HRSA), (3) CLIA-certified lab for basic diagnostics, and (4) high Medicare/Medicaid patient share. This project builds a pipeline that scores every practice on these dimensions, identifies RHC-eligible practices that haven\'t yet applied, and surfaces the revenue uplift from RHC cost-based reimbursement vs. standard fee-for-service.',
    workflows: [
      {
        name: 'Rural Eligibility Classification',
        desc: 'Map each practice ZIP to USDA RUCA codes (ZIP-level, from ers.usda.gov). RUCA ≥ 4 = non-urbanized. Cross-reference with Census urbanized area boundaries. Output: rural/non-rural flag per practice, RUCA code, and rurality tier (metro, micro, small town, rural).',
        fields: ['npi','address','practice_name','specialty','ruca_code','rurality_tier','facility_type_flag','fqhc_flag']
      },
      {
        name: 'Shortage Area Overlay',
        desc: 'Join HRSA HPSA and MUA/MUP designations (bulk download from data.hrsa.gov) with practice locations. A practice must be in a HPSA or MUA to qualify for RHC. Output: HPSA score, MUA flag, shortage area type (primary care, dental, mental health).',
        fields: ['npi','address','practice_name','hpsa_flag','mua_flag','hpsa_score','fqhc_flag','facility_type_flag','providers','provider_count']
      },
      {
        name: 'CLIA Lab Certification Check',
        desc: 'Cross-reference practices with CMS Provider of Services CLIA file (~244K lab records, quarterly from data.cms.gov). RHCs must hold a CLIA certificate (waiver or compliance) for basic lab: urinalysis, hemoglobin/hematocrit, blood glucose, stool occult blood, pregnancy tests. Output: CLIA status, certificate type, facility type, accreditation org.',
        fields: ['npi','address','practice_name','clia_status','clia_cert_type','facility_type_flag']
      },
      {
        name: 'Payer Mix Analysis',
        desc: 'Build revenue mix profile from Medicare Physician Utilization PUF — total beneficiaries, services, payments by CPT. Use Bene_Dual_Pct (% dual-eligible) as Medicaid proxy. High Medicare + Medicaid share = stronger RHC candidate. Output: Medicare revenue estimate, dual-eligible %, estimated payer split by CPT.',
        fields: ['npi','cpt_codes','medicare_service_count','medicare_beneficiary_count','medicare_allowed_amt','medicare_volume_by_cpt','dual_eligible_pct','payer_mix_estimate','est_annual_revenue']
      },
      {
        name: 'RHC Readiness Score',
        desc: 'Combine all signals into a composite RHC eligibility score: rural flag (pass/fail), shortage area (pass/fail), CLIA status (pass/fail), payer mix (% government). Rank practices by readiness. Estimate revenue uplift from RHC cost-based reimbursement vs current fee schedule.',
        fields: ['npi','practice_name','specialty','address','providers','provider_count','ruca_code','rurality_tier','hpsa_flag','mua_flag','clia_status','dual_eligible_pct','rhc_eligibility_score','medicare_allowed_amt','est_annual_revenue','payer_mix_estimate','facility_type_flag','fqhc_flag']
      }
    ],
    affiliations: [
      { tier: 'Federal & Rural Health Policy', items: [
        { name: 'HRSA Federal Office of Rural Health Policy (FORHP)', status: 'target', why: 'The federal agency that defines rural health designations and funds rural health programs. If FORHP uses your classifier, it becomes the reference standard.', contact: 'https://www.hrsa.gov/rural-health | FORHP director office: (301) 443-0835 | 5600 Fishers Lane, Rockville, MD 20857' },
        { name: 'National Rural Health Association (NRHA)', status: 'target', why: 'Largest rural health membership org (~21,000 members). Their endorsement reaches every rural practice and rural hospital in the country.', contact: 'https://www.ruralhealth.us | mail@nrharural.org | (816) 756-3140 | 4501 College Blvd #225, Leawood, KS 66211' },
        { name: 'National Association of Rural Health Clinics (NARHC)', status: 'target', why: 'The trade association for RHCs specifically. If your classifier helps their members, that\'s direct value to their constituency.', contact: 'https://www.narhc.org | info@narhc.org | (866) 306-1961' }
      ]},
      { tier: 'Research & Academic', items: [
        { name: 'RUPRI Center for Rural Health Policy Analysis', status: 'target', why: 'University of Iowa — leading rural health policy research center. Would validate your eligibility classification methodology.', contact: 'https://rupri.public-health.uiowa.edu | (319) 384-3831 | University of Iowa College of Public Health' },
        { name: 'UNC Cecil G. Sheps Center for Health Services Research', status: 'target', why: 'Maintains the definitive rural hospital closures tracking program. Your data complements their mission of monitoring rural healthcare access.', contact: 'https://www.shepscenter.unc.edu | (919) 966-5011 | 725 MLK Jr. Blvd, Chapel Hill, NC 27599' },
        { name: 'WWAMI Rural Health Research Center (Univ. of Washington)', status: 'target', why: 'Created the ZIP-code RUCA crosswalk your classifier uses. Natural partnership — they built the foundation, you built the application.', contact: 'https://familymedicine.uw.edu/rhrc/ | (206) 685-0402 | UW Dept of Family Medicine, Seattle, WA' }
      ]},
      { tier: 'State & Provider Associations', items: [
        { name: 'Massachusetts Health & Hospital Association', status: 'target', why: 'Represents MA hospitals and health systems including rural/critical access. Your POC state — direct access to facilities that could benefit from RHC designation.', contact: 'https://www.mhalink.org | (781) 272-8000 | 500 District Ave, Burlington, MA 01803' },
        { name: 'National Organization of State Offices of Rural Health (NOSORH)', status: 'target', why: 'Coordinates all 50 State Offices of Rural Health. Single relationship unlocks state-by-state distribution.', contact: 'https://nosorh.org | info@nosorh.org | (202) 560-0190' }
      ]},
      { tier: 'Quality & Accreditation', items: [
        { name: 'Joint Commission (RHC Accreditation Program)', status: 'target', why: 'Launched a specific RHC Accreditation Program. If your readiness score aligns with their standards, that\'s a credentialing pipeline.', contact: 'https://www.jointcommission.org/en-us/accreditation/rural-health-clinics/ | (630) 792-5000 | One Renaissance Blvd, Oakbrook Terrace, IL 60181' },
        { name: 'National Committee for Quality Assurance (NCQA)', status: 'target', why: 'If your RHC readiness methodology was NCQA-reviewed, it becomes a quality stamp for rural practices pursuing RHC certification.', contact: 'https://www.ncqa.org | customersupport@ncqa.org | (888) 275-7585' }
      ]}
    ],
    get allFields() {
      const s = new Set();
      this.workflows.forEach(w => w.fields.forEach(f => s.add(f)));
      return Array.from(s);
    }
  }
];

const userProjects = [];

function getAllProjects() { return [...PROJECTS, ...userProjects]; }

function getSourcesForFields(fieldNames) {
  const sources = new Set();
  fieldNames.forEach(fname => {
    const el = document.querySelector(`.field[data-name="${fname}"]`);
    if (el) el.dataset.sources.split(',').forEach(s => sources.add(s.trim()));
  });
  return Array.from(sources);
}

function getMissingSources(sourceIds) {
  return sourceIds.filter(s => !COMPLETED_SOURCES.has(s));
}

function getBacklogPosition(sourceId) {
  const idx = BACKLOG.findIndex(b => b.id === sourceId);
  return idx >= 0 ? idx + 1 : null;
}

function getBacklogEntry(sourceId) {
  return BACKLOG.find(b => b.id === sourceId) || null;
}

// ── Analytics helpers ──

function computeFieldUsage() {
  // Returns map: fieldName -> { count, workflows: [{projName, wfName}] }
  const usage = {};
  document.querySelectorAll('.field').forEach(f => { usage[f.dataset.name] = { count: 0, workflows: [] }; });
  getAllProjects().forEach(proj => {
    proj.workflows.forEach(wf => {
      wf.fields.forEach(fname => {
        if (usage[fname]) {
          usage[fname].count++;
          usage[fname].workflows.push({ projName: proj.name, wfName: wf.name });
        }
      });
    });
  });
  return usage;
}

function computeSourceBlastRadius(sid) {
  // Returns { fields, workflows, projects } affected if source goes down
  const fields = [];
  document.querySelectorAll('.field').forEach(f => {
    const srcs = f.dataset.sources.split(',').map(s => s.trim());
    // Only a risk if this is the ONLY source
    if (srcs.includes(sid)) fields.push(f.dataset.name);
  });
  const wfs = [];
  const projs = new Set();
  getAllProjects().forEach(proj => {
    proj.workflows.forEach(wf => {
      if (wf.fields.some(f => fields.includes(f))) {
        wfs.push({ projName: proj.name, wfName: wf.name });
        projs.add(proj.name);
      }
    });
  });
  return { fields, workflows: wfs, projects: Array.from(projs) };
}

function computeBacklogUnblocks() {
  // For each backlog source, how many workflows need it
  const map = {};
  BACKLOG.forEach(b => { map[b.id] = 0; });
  getAllProjects().forEach(proj => {
    proj.workflows.forEach(wf => {
      const wfSources = getSourcesForFields(wf.fields);
      const missing = getMissingSources(wfSources);
      missing.forEach(sid => {
        if (map[sid] !== undefined) map[sid]++;
      });
    });
  });
  return map;
}

function getWorkflowReadiness(wf) {
  const sources = getSourcesForFields(wf.fields);
  if (sources.length === 0) return 'green';
  const missing = getMissingSources(sources);
  const pct = (sources.length - missing.length) / sources.length;
  if (pct >= 1) return 'green';
  if (pct >= 0.5) return 'yellow';
  return 'red';
}

function getLatestETA(missingSources) {
  let latest = null;
  missingSources.forEach(sid => {
    const entry = getBacklogEntry(sid);
    if (entry) {
      const idx = ETA_ORDER.indexOf(entry.eta);
      if (idx >= 0 && (latest === null || idx > latest)) latest = idx;
    }
  });
  return latest !== null ? ETA_ORDER[latest] : null;
}

function getUnusedFields() {
  const usage = computeFieldUsage();
  return Object.keys(usage).filter(f => usage[f].count === 0);
}

// ── Render field annotations ──

function applyFieldAnnotations() {
  const usage = computeFieldUsage();

  document.querySelectorAll('.field').forEach(f => {
    const name = f.dataset.name;
    const u = usage[name] || { count: 0, workflows: [] };
    const srcs = f.dataset.sources.split(',').map(s => s.trim());

    // Heat dot
    const heatDot = f.querySelector('.heat-dot');
    const heatLevel = Math.min(u.count, 4);
    heatDot.className = `heat-dot heat-${heatLevel}`;
    if (u.count === 0) f.classList.add('heat-unused');
    else f.classList.remove('heat-unused');

    // Risk classification
    if (srcs.length === 1) {
      f.classList.add('single-source');
      f.classList.remove('multi-source');
    } else {
      f.classList.remove('single-source');
      f.classList.add('multi-source');
    }

    // Tooltip content
    const tooltip = f.querySelector('.field-tooltip');
    let tip = '';
    if (u.count > 0) {
      tip += `<strong>Used in ${u.count} workflow${u.count > 1 ? 's' : ''}:</strong><br>`;
      // Group by project
      const byProj = {};
      u.workflows.forEach(w => {
        if (!byProj[w.projName]) byProj[w.projName] = [];
        byProj[w.projName].push(w.wfName);
      });
      Object.entries(byProj).forEach(([pn, wfs]) => {
        tip += `${pn}: ${wfs.join(', ')}<br>`;
      });
    } else {
      tip += '<strong>Unused</strong> — no product references this field';
    }
    tip += `<br>Sources: ${srcs.join(', ')}`;
    if (srcs.length === 1) tip += '<br><span style="color:#fca5a5">Single-source risk</span>';
    tooltip.innerHTML = tip;
  });
}

// ── Render Projects ──

function renderProjects() {
  const container = document.getElementById('projects-container');
  container.innerHTML = '';

  const all = getAllProjects();
  all.forEach(proj => {
    container.appendChild(createProjectCard(proj));
  });

  const placeholder = document.createElement('div');
  placeholder.className = 'proj-box proj-placeholder';
  placeholder.id = 'new-project-trigger';
  placeholder.style.cssText = 'border-color:#e0e0e0; cursor:pointer;';
  placeholder.innerHTML = '<div class="proj-name" style="color:#ccc;">+ New Product</div><div class="proj-desc" style="color:#ddd; font-style:italic;">Define fields &amp; sources</div>';
  placeholder.addEventListener('click', openCreateForm);
  container.appendChild(placeholder);

  reattachProjectHovers();
  applyFieldAnnotations();
  updateInsightsBar();
  setTimeout(drawAllLines, 50);
}

function createProjectCard(proj) {
  const box = document.createElement('div');
  box.className = 'proj-box';
  box.id = proj.id;
  box.dataset.fields = proj.allFields.join(',');
  box.dataset.type = proj.type;
  box.dataset.projId = proj.id;

  const fields = proj.allFields;
  const sources = getSourcesForFields(fields);
  const integrated = sources.length - getMissingSources(sources).length;
  const pct = sources.length > 0 ? Math.round((integrated / sources.length) * 100) : 0;

  // Active phase info for the compact card
  const activePhase = proj.phases ? proj.phases.find(p => p.status === 'active') : null;
  let phaseHTML = '';
  if (activePhase) {
    const apPct = activePhase.deliverables.length > 0
      ? Math.round(activePhase.deliverables.reduce((s, d) => s + d.pct, 0) / activePhase.deliverables.length) : 0;
    const apDone = activePhase.deliverables.filter(d => d.status === 'done').length;
    phaseHTML = `<div style="margin-top:4px;padding:4px 6px;background:#f8f8fc;border-radius:4px;border:1px solid #eee;">
      <div style="font-size:8px;font-weight:700;color:#6366f1;text-transform:uppercase;letter-spacing:0.5px;">${activePhase.name}</div>
      <div style="display:flex;align-items:center;gap:6px;margin-top:3px;">
        <div style="flex:1;height:3px;background:#e5e7eb;border-radius:2px;overflow:hidden;"><div style="height:100%;width:${apPct}%;background:#6366f1;border-radius:2px;"></div></div>
        <span style="font-size:8px;font-weight:700;color:#888;">${apDone}/${activePhase.deliverables.length}</span>
        <span style="font-size:7px;font-weight:700;color:#92400e;background:#fef3c7;padding:1px 4px;border-radius:3px;">${activePhase.deadline}</span>
      </div>
    </div>`;
  }

  const header = document.createElement('div');
  header.className = 'proj-header';
  header.innerHTML = `
    <div style="flex:1">
      <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;">
        <span class="proj-name" style="margin-bottom:0">${proj.name}</span>
        <span class="proj-type-badge ${proj.type}">${proj.type}</span>
      </div>
      ${proj.owner ? `<div style="font-size:8px;color:#888;margin-top:2px;">Owner: <strong style="color:#555;">${proj.owner}</strong></div>` : ''}
      <div class="proj-desc" style="display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;">${proj.shortDesc}</div>
      <div class="proj-meta">${fields.length} fields · ${sources.length} sources · ${pct}% ready</div>
      ${phaseHTML}
    </div>
    <span class="proj-open-hint" style="font-size:16px;color:#ccc;flex-shrink:0;">&#8599;</span>
  `;

  box.appendChild(header);

  header.addEventListener('click', (e) => {
    e.stopPropagation();
    openDetailPanel(proj);
  });

  return box;
}

// ── Detail Panel ──

let detailPanelOpen = false;

function openDetailPanel(proj) {
  const overlay = document.getElementById('detail-overlay');
  const panel = document.getElementById('detail-panel');
  detailPanelOpen = true;

  const fields = proj.allFields;
  const sources = getSourcesForFields(fields);
  const missing = getMissingSources(sources);
  const integrated = sources.length - missing.length;
  const pct = sources.length > 0 ? Math.round((integrated / sources.length) * 100) : 0;
  const hasArch = proj.architecture && proj.architecture.nodes;
  const hasPhases = proj.phases && proj.phases.length > 0;
  const hasAffil = proj.affiliations && proj.affiliations.length > 0;
  const hasTabs = hasArch || hasPhases || hasAffil;

  let html = '';

  // Header
  html += `<div class="detail-panel-header">
    <div class="detail-panel-header-info">
      <div class="detail-panel-title">
        ${proj.name}
        <span class="proj-type-badge ${proj.type}">${proj.type}</span>
      </div>
      <div class="detail-panel-desc">${proj.shortDesc}</div>
      <div class="detail-panel-meta">${proj.owner ? proj.owner + ' · ' : ''}${fields.length} fields · ${sources.length} sources · ${pct}% data ready</div>
    </div>
    <button class="detail-close" onclick="closeDetailPanel()">&times;</button>
  </div>`;

  // Body with tabs
  html += '<div class="detail-panel-body">';

  if (hasTabs) {
    html += '<div class="detail-tabs">';
    html += '<button class="detail-tab active" onclick="switchDetailTab(this,\'tab-intel\')">Intelligence</button>';
    if (hasPhases) html += '<button class="detail-tab" onclick="switchDetailTab(this,\'tab-phases\')">Phases</button>';
    if (hasArch) html += '<button class="detail-tab" onclick="switchDetailTab(this,\'tab-arch\')">Architecture</button>';
    if (hasAffil) html += '<button class="detail-tab" onclick="switchDetailTab(this,\'tab-affil\')">Affiliations</button>';
    html += '</div>';
  }

  // ── Intelligence tab ──
  html += '<div class="detail-tab-content active" id="tab-intel">';

  // ── (Phases tab rendered after Intelligence) ──

  if (proj.objective) {
    html += '<div class="proj-section-title">Objective</div>';
    html += `<div class="proj-objective">${proj.objective}</div>`;
  }

  if (proj.workflows.length > 0) {
    html += '<div class="proj-section-title">Workflows</div>';
    proj.workflows.forEach((wf, i) => {
      const readiness = getWorkflowReadiness(wf);
      const dotClass = readiness === 'green' ? 'wf-dot-green' : readiness === 'yellow' ? 'wf-dot-yellow' : 'wf-dot-red';
      const descHtml = wf.desc ? `<div class="wf-desc">${wf.desc}</div>` : '';
      html += `<div class="wf-item" data-wf-fields="${wf.fields.join(',')}" data-proj-id="${proj.id}">
        <div class="wf-status-dot ${dotClass}" title="${readiness === 'green' ? 'All sources ready' : readiness === 'yellow' ? 'Some sources missing' : 'Most sources missing'}"></div>
        <div class="wf-content">
          <div><span class="wf-number">${i + 1}.</span><span class="wf-name">${wf.name}</span></div>
          ${descHtml}
          <div class="wf-fields-list">${wf.fields.join(', ')}</div>
        </div>
      </div>`;
    });
  }

  if (fields.length > 0) {
    html += '<div class="proj-section-title">Data Readiness</div>';
    html += '<div class="data-readiness">';
    html += `<div class="readiness-text">${integrated} of ${sources.length} sources integrated (${pct}%)</div>`;
    html += `<div class="readiness-bar-wrap"><div class="readiness-bar" style="width:${pct}%"></div></div>`;

    if (missing.length > 0) {
      const latestEta = getLatestETA(missing);
      if (latestEta) {
        const etaIdx = ETA_ORDER.indexOf(latestEta);
        const totalSteps = ETA_ORDER.length;
        const doneWidth = pct;
        const pendingWidth = Math.round(((etaIdx + 1) / totalSteps) * (100 - pct));
        html += '<div class="proj-timeline">';
        html += `<div class="readiness-text" style="margin-bottom:2px">Projected completion: <strong>${latestEta}</strong></div>`;
        html += '<div class="timeline-bar-wrap">';
        html += `<div class="timeline-segment timeline-done" style="width:${doneWidth}%"></div>`;
        html += `<div class="timeline-segment timeline-pending" style="left:${doneWidth}%;width:${pendingWidth}%"></div>`;
        html += '</div>';
        html += '<div class="timeline-labels"><span class="timeline-label">Now</span><span class="timeline-label">' + latestEta + '</span></div>';
        html += '</div>';
      }

      html += '<div style="margin-top:6px">';
      missing.forEach(sid => {
        const pos = getBacklogPosition(sid);
        const entry = getBacklogEntry(sid);
        const label = entry ? entry.name : sid;
        const eta = entry ? `, ETA ${entry.eta}` : '';
        const posLabel = pos ? `#${pos} in backlog` : 'not scheduled';
        html += `<span class="missing-src"><span class="mpos">${label}</span> — ${posLabel}${eta}</span> `;
      });
      html += '</div>';
    }
    html += '</div>';
  }

  if (proj.workflows.length > 0) {
    const allWarehouseFields = Array.from(document.querySelectorAll('.field')).map(f => f.dataset.name);
    const projFieldSet = new Set(proj.allFields);
    const unused = allWarehouseFields.filter(f => !projFieldSet.has(f));
    if (unused.length > 0 && unused.length < allWarehouseFields.length) {
      html += '<div class="proj-section-title">Untapped Fields <span style="font-weight:400;text-transform:none;letter-spacing:0;color:#aaa;">(' + unused.length + ' available)</span></div>';
      html += '<div style="max-height:80px;overflow-y:auto;">';
      unused.forEach(f => { html += `<span class="gap-field gap-unused">${f}</span> `; });
      html += '</div>';
    }
  }

  html += '</div>'; // end tab-intel

  // ── Phases tab ──
  if (hasPhases) {
    html += '<div class="detail-tab-content" id="tab-phases">';
    html += renderPhases(proj.phases);
    html += '</div>';
  }

  // ── Architecture tab ──
  if (hasArch) {
    html += `<div class="detail-tab-content" id="tab-arch">`;
    html += renderArchitecture(proj.architecture);
    html += '</div>';
  }

  // ── Affiliations tab ──
  if (hasAffil) {
    html += '<div class="detail-tab-content" id="tab-affil">';
    html += renderAffiliations(proj.affiliations);
    html += '</div>';
  }

  html += '</div>'; // end detail-panel-body
  panel.innerHTML = html;
  overlay.classList.add('open');

  // Attach workflow hovers inside the panel
  panel.querySelectorAll('.wf-item').forEach(wf => {
    wf.addEventListener('mouseenter', (e) => {
      e.stopPropagation();
      const fieldNames = wf.dataset.wfFields.split(',').map(s => s.trim());
      dimAll();
      const projBox = document.getElementById(proj.id);
      if (projBox) projBox.classList.add('hl');
      lake.classList.add('hl');
      const allSrc = new Set();
      fieldNames.forEach(fname => {
        const fel = document.querySelector(`.field[data-name="${fname}"]`);
        if (fel) { fel.classList.add('hl'); fel.dataset.sources.split(',').forEach(s => allSrc.add(s.trim())); }
      });
      allSrc.forEach(hlSource);
      hlLines(fieldNames, true);
    });
    wf.addEventListener('mouseleave', () => { resetAll(); });
  });

  overlay.onclick = (e) => {
    if (e.target === overlay) closeDetailPanel();
  };
}

function switchDetailTab(btn, tabId) {
  const panel = btn.closest('.detail-panel-body');
  panel.querySelectorAll('.detail-tab').forEach(t => t.classList.remove('active'));
  panel.querySelectorAll('.detail-tab-content').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById(tabId).classList.add('active');
}

function renderPhases(phases) {
  let html = '';
  phases.forEach(phase => {
    const totalPct = phase.deliverables.length > 0
      ? Math.round(phase.deliverables.reduce((sum, d) => sum + d.pct, 0) / phase.deliverables.length)
      : 0;
    const done = phase.deliverables.filter(d => d.status === 'done').length;
    const total = phase.deliverables.length;
    const isActive = phase.status === 'active';

    html += `<div class="phase-card${isActive ? ' phase-active' : ''}">`;
    html += '<div class="phase-header">';
    html += `<div class="phase-status-ring" style="--phase-pct:${totalPct * 3.6}deg"><span>${totalPct}%</span></div>`;
    html += '<div class="phase-info">';
    html += `<div class="phase-name">${phase.name}`;
    const dlClass = phase.status === 'complete' ? ' phase-complete' : '';
    html += ` <span class="phase-deadline${dlClass}">${phase.deadline}</span>`;
    html += '</div>';
    html += `<div class="phase-scope">${phase.desc}</div>`;
    html += '</div></div>';

    // Overall progress bar
    html += `<div class="phase-progress-bar"><div class="phase-progress-fill" style="width:${totalPct}%"></div></div>`;
    html += `<div style="padding:0 14px;font-size:8px;color:#999;margin-bottom:4px;">${done}/${total} deliverables complete</div>`;

    // Deliverables
    html += '<div class="phase-deliverables">';
    phase.deliverables.forEach(d => {
      const dotClass = d.status === 'done' ? 'deliv-dot-done' : d.status === 'wip' ? 'deliv-dot-wip' : 'deliv-dot-pending';
      const barClass = d.status === 'done' ? 'db-done' : d.status === 'wip' ? 'db-wip' : 'db-pending';
      const pctClass = d.status === 'done' ? 'dp-done' : d.status === 'wip' ? 'dp-wip' : '';

      html += '<div class="deliv-item">';
      html += `<div class="deliv-dot ${dotClass}"></div>`;
      html += '<div class="deliv-info">';
      if (d.url) {
        html += `<div class="deliv-name"><a href="${d.url}" target="_blank" rel="noopener">${d.name}<span class="deliv-link-icon">&#8599;</span></a></div>`;
      } else {
        html += `<div class="deliv-name">${d.name}</div>`;
      }
      html += `<div class="deliv-desc">${d.desc}</div>`;
      html += '</div>';
      html += `<div class="deliv-bar"><div class="deliv-bar-fill ${barClass}" style="width:${d.pct}%"></div></div>`;
      html += `<div class="deliv-pct ${pctClass}">${d.pct}%</div>`;
      html += '</div>';
    });
    html += '</div></div>';
  });
  return html;
}

function renderAffiliations(affiliations) {
  let html = '';
  affiliations.forEach(tier => {
    html += '<div class="affil-tier">';
    html += `<div class="affil-tier-label">${tier.tier}</div>`;
    tier.items.forEach(item => {
      const statusClass = item.status === 'affiliated' ? 'as-affiliated' : item.status === 'outreach' ? 'as-outreach' : 'as-target';
      const statusLabel = item.status === 'affiliated' ? 'Affiliated' : item.status === 'outreach' ? 'In Outreach' : 'Target';
      html += `<div class="affil-card">
        <div style="display:flex;align-items:center;gap:6px;">
          <div class="affil-name">${item.name}</div>
          <span class="affil-status ${statusClass}">${statusLabel}</span>
        </div>
        <div class="affil-why">${item.why}</div>
        <div class="affil-contact">${item.contact.replace(/(https?:\/\/[^\s|,]+)/g, '<a href="$1" target="_blank">$1</a>').replace(/\|/g, '<br>')}</div>
      </div>`;
    });
    html += '</div>';
  });
  return html;
}

function renderArchitecture(arch) {
  let html = '<div class="arch-flow">';

  arch.nodes.forEach((node, i) => {
    const flow = arch.flows.find(f => f.to === node.id);
    if (i > 0 && flow) {
      html += `<div class="arch-arrow"><span class="arch-arrow-label">${flow.label || ''}</span></div>`;
    } else if (i > 0) {
      html += '<div class="arch-arrow"></div>';
    }

    html += `<div class="arch-t-${node.type}" style="width:100%"><div class="arch-node">`;
    html += '<div class="arch-node-header">';
    html += `<div class="arch-node-icon">${node.icon}</div>`;
    html += `<div style="flex:1"><div class="arch-node-name">${node.name}</div></div>`;
    if (node.cost) html += `<span class="arch-cost">${node.cost}</span>`;
    html += '</div>';
    html += `<div class="arch-node-desc">${node.desc}</div>`;
    if (node.detail) html += `<div class="arch-node-detail">${node.detail}</div>`;

    if (node.children) {
      html += '<div class="arch-node-children">';
      node.children.forEach(c => { html += `<span class="arch-child">${c}</span>`; });
      html += '</div>';
    }

    if (node.tables) {
      html += '<div class="arch-tables">';
      node.tables.forEach(t => {
        const sc = t.status === 'done' ? 'at-done' : t.status === 'wip' ? 'at-wip' : 'at-pending';
        const bg = t.status === 'done' ? 'background:#f0fdf4;border-color:#bbf7d0;color:#166534;' :
                   t.status === 'wip' ? 'background:#fefce8;border-color:#fde68a;color:#854d0e;' :
                   'background:#f9fafb;border-color:#e5e7eb;color:#9ca3af;';
        html += `<span class="arch-table" style="${bg}" title="${t.desc}"><span class="at-status ${sc}"></span>${t.name}</span>`;
      });
      html += '</div>';
    }

    html += '</div></div>';
  });

  html += '</div>';

  // ETL flow summary
  html += '<div class="proj-section-title" style="margin-top:16px">Data Flow</div>';
  html += '<div style="font-size:9px;color:#555;line-height:1.8;">';
  html += '<strong>1.</strong> Download — CMS / TiC / QPP APIs &rarr; raw files on Mac Mini<br>';
  html += '<strong>2.</strong> Filter — Python filters to MA + target taxonomy/CPT codes<br>';
  html += '<strong>3.</strong> Load — CSV upload to BigQuery, raw files discarded<br>';
  html += '<strong>4.</strong> Enrich — Claude classifies practice websites &rarr; structured JSON &rarr; BigQuery<br>';
  html += '<strong>5.</strong> Join — BigQuery SQL joins all tables &rarr; provider_comparison_v2<br>';
  html += '<strong>6.</strong> Analyze — Streamlit dashboard + Claude insights report<br>';
  html += '<strong>7.</strong> Legal — Claude generates CIN docs + employer contracts';
  html += '</div>';

  return html;
}

function closeDetailPanel() {
  document.getElementById('detail-overlay').classList.remove('open');
  detailPanelOpen = false;
  resetAll();
}

// ── Workflow hover (handled inside openDetailPanel) ──

// ── Project hover ──

function reattachProjectHovers() {
  document.querySelectorAll('.proj-box[data-fields]').forEach(p => {
    p.addEventListener('mouseenter', () => {
      if (impactLocked) return;
      const fieldNames = p.dataset.fields.split(',').map(s => s.trim()).filter(Boolean);
      if (fieldNames.length === 0) return;
      dimAll();
      p.classList.add('hl');
      lake.classList.add('hl');
      const allSources = new Set();
      fieldNames.forEach(fname => {
        const fel = document.querySelector(`.field[data-name="${fname}"]`);
        if (fel) {
          fel.classList.add('hl');
          fel.dataset.sources.split(',').forEach(s => allSources.add(s.trim()));
        }
      });
      allSources.forEach(hlSource);
      hlLines(fieldNames, false);
    });
    p.addEventListener('mouseleave', () => { if (!impactLocked) resetAll(); });
  });
}

// ── Status Controls ──

function toggleCompleted() {
  const btn = document.getElementById('btn-completed');
  btn.classList.toggle('active');
  pipeline.classList.toggle('show-status');
}

function applyCompletedStatus() {
  document.querySelectorAll('.src-item').forEach(item => {
    if (COMPLETED_SOURCES.has(item.dataset.id)) {
      item.classList.add('src-completed');
    }
  });
}

// ── Heatmap ──

function toggleHeatmap() {
  const btn = document.getElementById('btn-heatmap');
  btn.classList.toggle('active-blue');
  pipeline.classList.toggle('show-heatmap');
  updateLegend();
}

// ── Risk ──

function toggleRisk() {
  const btn = document.getElementById('btn-risk');
  btn.classList.toggle('active-amber');
  pipeline.classList.toggle('show-risk');
  updateLegend();
}

// ── Impact mode ──

let impactMode = false;
let impactLocked = false;
let lockedSourceId = null;

function toggleImpact() {
  const btn = document.getElementById('btn-impact');
  impactMode = !impactMode;
  btn.classList.toggle('active-red', impactMode);
  pipeline.classList.toggle('impact-mode', impactMode);

  if (!impactMode) {
    clearImpactLock();
  }
  updateLegend();
}

function clearImpactLock() {
  impactLocked = false;
  lockedSourceId = null;
  document.querySelectorAll('.impact-locked').forEach(el => el.classList.remove('impact-locked'));
  resetAll();
  updateInsightsBar();
}

function handleImpactClick(e) {
  if (!impactMode) return;
  const srcItem = e.currentTarget;
  const sid = srcItem.dataset.id;

  if (lockedSourceId === sid) {
    clearImpactLock();
    return;
  }

  clearImpactLock();
  impactLocked = true;
  lockedSourceId = sid;
  srcItem.classList.add('impact-locked');

  const blast = computeSourceBlastRadius(sid);

  dimAll();
  srcItem.classList.add('hl');
  srcItem.closest('.source-group').querySelector('.sg-header').classList.add('hl');
  lake.classList.add('hl');

  blast.fields.forEach(fname => {
    const fel = document.querySelector(`.field[data-name="${fname}"]`);
    if (fel) fel.classList.add('hl');
  });
  hlLines(blast.fields, true);

  document.querySelectorAll('.proj-box[data-fields]').forEach(p => {
    const pf = p.dataset.fields.split(',').map(x => x.trim());
    if (blast.fields.some(f => pf.includes(f))) p.classList.add('hl');
  });

  // Show blast radius in insights bar
  const bar = document.getElementById('insights-bar');
  const srcName = srcItem.querySelector('.sn').textContent;
  bar.innerHTML = `
    <div class="insight-stat"><span class="insight-num" style="color:#ef4444">${srcName}</span><span class="insight-label">Blast Radius</span></div>
    <div class="insight-stat"><span class="insight-num">${blast.fields.length}</span><span class="insight-label">fields<br>affected</span></div>
    <div class="insight-stat"><span class="insight-num">${blast.workflows.length}</span><span class="insight-label">workflows<br>affected</span></div>
    <div class="insight-stat"><span class="insight-num">${blast.projects.length}</span><span class="insight-label">products<br>affected</span></div>
    <div style="font-size:9px;color:#94a3b8;margin-left:auto;">Click source again to deselect</div>
  `;
  bar.classList.add('open');
}

// ── Backlog Panel ──

function renderBacklog() {
  const unblocks = computeBacklogUnblocks();
  const list = document.getElementById('backlog-list');
  let html = '';
  BACKLOG.forEach((item, i) => {
    const progress = Math.max(5, Math.min(95, ((BACKLOG.length - i) / BACKLOG.length) * 80 + 10));
    const ub = unblocks[item.id] || 0;
    html += `<div class="backlog-item">
      <span class="backlog-rank">${i + 1}</span>
      <div class="backlog-info">
        <div class="backlog-name">${item.name}</div>
        <div class="backlog-eta">ETA: ${item.eta}</div>
      </div>
      ${ub > 0 ? `<span class="backlog-unblocks">${ub} wf${ub > 1 ? 's' : ''}</span>` : ''}
      <div class="backlog-bar-wrap"><div class="backlog-bar" style="width:${progress}%"></div></div>
    </div>`;
  });
  list.innerHTML = html;
}

function toggleBacklog() {
  const overlay = document.getElementById('backlog-overlay');
  const btn = document.getElementById('btn-backlog');
  if (overlay.classList.contains('open')) {
    overlay.classList.remove('open');
    btn.classList.remove('active');
  } else {
    renderBacklog();
    overlay.classList.add('open');
    btn.classList.add('active');
  }
}

function closeBacklog(e) {
  if (e && e.target !== document.getElementById('backlog-overlay')) return;
  document.getElementById('backlog-overlay').classList.remove('open');
  document.getElementById('btn-backlog').classList.remove('active');
}

// ── Insights bar ──

function updateInsightsBar() {
  if (impactLocked) return; // Don't overwrite impact display
  const bar = document.getElementById('insights-bar');
  const usage = computeFieldUsage();
  const allFields = Object.keys(usage);
  const usedFields = allFields.filter(f => usage[f].count > 0);
  const unusedFields = allFields.filter(f => usage[f].count === 0);
  const singleSourceFields = allFields.filter(f => {
    const el = document.querySelector(`.field[data-name="${f}"]`);
    return el && el.dataset.sources.split(',').length === 1;
  });
  const riskFieldsUsed = singleSourceFields.filter(f => usage[f].count > 0);

  // Most used field
  let topField = null, topCount = 0;
  Object.entries(usage).forEach(([f, u]) => {
    if (u.count > topCount) { topCount = u.count; topField = f; }
  });

  bar.innerHTML = `
    <div class="insight-stat"><span class="insight-num">${usedFields.length}</span><span class="insight-label">fields<br>in use</span></div>
    <div class="insight-stat"><span class="insight-num">${unusedFields.length}</span><span class="insight-label">unused<br>fields</span></div>
    <div class="insight-stat"><span class="insight-num" style="color:#ef4444">${riskFieldsUsed.length}</span><span class="insight-label">single-source<br>risk fields</span></div>
    <div class="insight-stat"><span class="insight-num" style="color:#fbbf24">${BACKLOG.length}</span><span class="insight-label">sources in<br>backlog</span></div>
    ${topField ? `<div class="insight-stat"><span class="insight-num" style="color:#22c55e;font-size:12px;">${topField}</span><span class="insight-label">most used<br>(${topCount} workflows)</span></div>` : ''}
  `;
  bar.classList.add('open');
}

// ── Legend bar ──

function updateLegend() {
  const bar = document.getElementById('legend-bar');
  let items = [];

  if (pipeline.classList.contains('show-heatmap')) {
    items.push('<span style="font-weight:700;margin-right:4px;">HEATMAP:</span>');
    items.push('<div class="legend-item"><span class="legend-dot" style="background:#d1d5db"></span>Unused</div>');
    items.push('<div class="legend-item"><span class="legend-dot" style="background:#93c5fd"></span>1 workflow</div>');
    items.push('<div class="legend-item"><span class="legend-dot" style="background:#fbbf24"></span>2 workflows</div>');
    items.push('<div class="legend-item"><span class="legend-dot" style="background:#fb923c"></span>3 workflows</div>');
    items.push('<div class="legend-item"><span class="legend-dot" style="background:#ef4444"></span>4+ workflows</div>');
  }
  if (pipeline.classList.contains('show-risk')) {
    if (items.length) items.push('<span style="margin:0 8px;color:#ccc;">|</span>');
    items.push('<span style="font-weight:700;margin-right:4px;">RISK:</span>');
    items.push('<div class="legend-item"><span class="legend-dot" style="background:#ef4444"></span>Single source</div>');
    items.push('<div class="legend-item"><span class="legend-dot" style="background:#22c55e;border:1px solid #16a34a;"></span>Multi-source</div>');
  }
  if (pipeline.classList.contains('impact-mode')) {
    if (items.length) items.push('<span style="margin:0 8px;color:#ccc;">|</span>');
    items.push('<span style="font-weight:700;margin-right:4px;">IMPACT:</span>');
    items.push('<div class="legend-item">Click any source to see its blast radius</div>');
  }
  if (pipeline.classList.contains('show-effort')) {
    if (items.length) items.push('<span style="margin:0 8px;color:#ccc;">|</span>');
    items.push('<span style="font-weight:700;margin-right:4px;">EFFORT:</span>');
    items.push('<div class="legend-item"><span class="legend-dot effort-low"></span>Low</div>');
    items.push('<div class="legend-item"><span class="legend-dot effort-med"></span>Medium</div>');
    items.push('<div class="legend-item"><span class="legend-dot effort-high"></span>High</div>');
    items.push('<div class="legend-item"><span class="legend-dot effort-vhigh"></span>Very High</div>');
  }

  if (items.length) {
    bar.innerHTML = items.join('');
    bar.classList.add('open');
  } else {
    bar.classList.remove('open');
  }
}

// ── Create Project Form ──

let formActive = false;
let selectedFields = new Set();

function openCreateForm() {
  if (formActive) return;
  formActive = true;
  const trigger = document.getElementById('new-project-trigger');
  trigger.className = 'proj-box';
  trigger.style.cssText = '';
  trigger.removeEventListener('click', openCreateForm);

  trigger.innerHTML = `
    <div class="proj-form">
      <div class="form-group">
        <label>Product Name</label>
        <input type="text" id="form-name" placeholder="e.g. Provider Analytics">
      </div>
      <div class="form-group">
        <label>Type</label>
        <div class="type-toggle">
          <button class="type-toggle-btn active" data-type="external" onclick="setFormType(this)">External</button>
          <button class="type-toggle-btn" data-type="internal" onclick="setFormType(this)">Internal</button>
        </div>
      </div>
      <div class="form-group">
        <label>Objective</label>
        <textarea id="form-objective" placeholder="Describe the product goal..."></textarea>
      </div>
      <div class="form-group">
        <label>Workflows</label>
        <div id="wf-entries"></div>
        <button class="add-wf-btn" onclick="addWorkflowEntry()">+ Add Workflow</button>
      </div>
      <div class="form-group">
        <label>Selected Fields <span style="font-weight:400;text-transform:none;letter-spacing:0">(click fields in warehouse)</span></label>
        <div id="selected-fields-display" class="selected-fields-list"></div>
      </div>
      <div class="form-group">
        <label>Auto-detected Sources</label>
        <div id="form-sources" class="form-auto-sources" style="color:#aaa;">Select fields to see required sources</div>
      </div>
      <div class="form-btns">
        <button class="btn-save" onclick="saveNewProject()">Save Product</button>
        <button class="btn-cancel" onclick="cancelCreateForm()">Cancel</button>
      </div>
    </div>
  `;

  selectedFields = new Set();
  addWorkflowEntry();
  document.querySelectorAll('.field').forEach(f => f.classList.add('selectable'));
  document.getElementById('warehouse').addEventListener('click', fieldPickerHandler);
  setTimeout(drawAllLines, 50);
}

function fieldPickerHandler(e) {
  const field = e.target.closest('.field');
  if (!field || !formActive) return;
  const name = field.dataset.name;
  if (selectedFields.has(name)) { selectedFields.delete(name); field.classList.remove('selected'); }
  else { selectedFields.add(name); field.classList.add('selected'); }
  updateSelectedFieldsDisplay();
  updateFormSources();
}

function updateSelectedFieldsDisplay() {
  const container = document.getElementById('selected-fields-display');
  if (!container) return;
  if (selectedFields.size === 0) { container.innerHTML = '<span style="font-size:9px;color:#aaa;">None selected</span>'; return; }
  container.innerHTML = Array.from(selectedFields).map(f =>
    `<span class="sel-field-pill">${f}<span class="pill-x" onclick="removeFormField('${f}')">&times;</span></span>`
  ).join('');
}

function removeFormField(fname) {
  selectedFields.delete(fname);
  const el = document.querySelector(`.field[data-name="${fname}"]`);
  if (el) el.classList.remove('selected');
  updateSelectedFieldsDisplay();
  updateFormSources();
}

function updateFormSources() {
  const container = document.getElementById('form-sources');
  if (!container) return;
  const fields = Array.from(selectedFields);
  if (fields.length === 0) { container.innerHTML = '<span style="color:#aaa;">Select fields to see required sources</span>'; return; }
  const sources = getSourcesForFields(fields);
  const missing = getMissingSources(sources);
  const integrated = sources.length - missing.length;
  let html = `<strong>${integrated}/${sources.length}</strong> sources integrated`;
  if (missing.length > 0) {
    html += '<br>Missing: ';
    html += missing.map(sid => {
      const entry = getBacklogEntry(sid);
      const pos = getBacklogPosition(sid);
      const label = entry ? entry.name : sid;
      const eta = entry ? ` ETA ${entry.eta}` : '';
      const posStr = pos ? `#${pos}` : '?';
      return `<span class="missing-src"><span class="mpos">${label}</span> — ${posStr}${eta}</span>`;
    }).join(' ');
  }
  container.innerHTML = html;
}

function setFormType(btn) {
  btn.parentElement.querySelectorAll('.type-toggle-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}

function addWorkflowEntry() {
  const container = document.getElementById('wf-entries');
  if (!container) return;
  const idx = container.children.length + 1;
  const div = document.createElement('div');
  div.className = 'wf-entry';
  div.innerHTML = `<input type="text" placeholder="Workflow ${idx} name"><button class="wf-remove-btn" onclick="this.parentElement.remove()">&times;</button>`;
  container.appendChild(div);
}

function saveNewProject() {
  const name = document.getElementById('form-name').value.trim();
  if (!name) { document.getElementById('form-name').style.borderColor = '#dc2626'; return; }
  const typeBtn = document.querySelector('.type-toggle-btn.active');
  const type = typeBtn ? typeBtn.dataset.type : 'external';
  const objective = document.getElementById('form-objective').value.trim();
  const wfEntries = document.querySelectorAll('#wf-entries .wf-entry input');
  const workflows = [];
  wfEntries.forEach(input => {
    const wfName = input.value.trim();
    if (wfName) workflows.push({ name: wfName, fields: Array.from(selectedFields) });
  });
  const proj = {
    id: 'proj-' + name.toLowerCase().replace(/[^a-z0-9]+/g, '-'),
    name, type,
    shortDesc: objective.substring(0, 120) + (objective.length > 120 ? '...' : ''),
    objective, workflows,
    get allFields() { const s = new Set(); this.workflows.forEach(w => w.fields.forEach(f => s.add(f))); return Array.from(s); }
  };
  userProjects.push(proj);
  exitFieldSelectionMode();
  formActive = false;
  renderProjects();
}

function cancelCreateForm() {
  exitFieldSelectionMode();
  formActive = false;
  renderProjects();
}

function exitFieldSelectionMode() {
  document.querySelectorAll('.field').forEach(f => f.classList.remove('selectable', 'selected'));
  document.getElementById('warehouse').removeEventListener('click', fieldPickerHandler);
  selectedFields = new Set();
}

// ── SVG Lines ──

function drawAllLines() {
  const wr = wrap.getBoundingClientRect();
  svg.style.width = wrap.scrollWidth + 'px';
  svg.style.height = wrap.scrollHeight + 'px';
  svg.setAttribute('viewBox', `0 0 ${wrap.scrollWidth} ${wrap.scrollHeight}`);
  svg.innerHTML = '';

  document.querySelectorAll('.field').forEach(field => {
    const sids = field.dataset.sources.split(',').map(s => s.trim());
    const fRect = field.getBoundingClientRect();
    const fx = fRect.left - wr.left + wrap.scrollLeft;
    const fy = fRect.top - wr.top + wrap.scrollTop + fRect.height / 2;

    sids.forEach(sid => {
      const srcEl = document.querySelector(`.src-item[data-id="${sid}"]`);
      if (!srcEl) return;
      const sRect = srcEl.getBoundingClientRect();
      const sx = sRect.right - wr.left + wrap.scrollLeft;
      const sy = sRect.top - wr.top + wrap.scrollTop + sRect.height / 2;
      const midX = (sx + fx) / 2;
      const d = `M ${sx} ${sy} C ${midX} ${sy}, ${midX} ${fy}, ${fx} ${fy}`;
      const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      path.setAttribute('d', d);
      path.setAttribute('stroke', SRC_COLORS[sid] || '#ccc');
      path.setAttribute('stroke-width', '1');
      path.setAttribute('fill', 'none');
      path.setAttribute('opacity', '0.07');
      path.dataset.source = sid;
      path.dataset.field = field.dataset.name;
      svg.appendChild(path);
    });
  });
}

// ── Hover helpers ──

function dimAll() { pipeline.classList.add('hov'); }
function resetAll() {
  pipeline.classList.remove('hov');
  document.querySelectorAll('.hl').forEach(el => el.classList.remove('hl'));
  document.querySelectorAll('#svg path').forEach(p => {
    p.setAttribute('opacity', '0.07');
    p.setAttribute('stroke-width', '1');
  });
}

function hlSource(sid) {
  const el = document.querySelector(`.src-item[data-id="${sid}"]`);
  if (el) { el.classList.add('hl'); el.closest('.source-group').querySelector('.sg-header').classList.add('hl'); }
}

function hlLines(fieldNames, thick) {
  const fset = new Set(fieldNames);
  document.querySelectorAll('#svg path').forEach(p => {
    if (fset.has(p.dataset.field)) {
      p.setAttribute('opacity', thick ? '0.55' : '0.45');
      p.setAttribute('stroke-width', thick ? '2.2' : '1.6');
    } else {
      p.setAttribute('opacity', '0.02');
    }
  });
}

// ── Field hover ──

document.querySelectorAll('.field').forEach(f => {
  f.addEventListener('mouseenter', () => {
    if (formActive || impactLocked) return;
    dimAll();
    f.classList.add('hl');
    lake.classList.add('hl');
    const sids = f.dataset.sources.split(',').map(s => s.trim());
    sids.forEach(hlSource);
    hlLines([f.dataset.name], true);
    document.querySelectorAll('.proj-box[data-fields]').forEach(p => {
      const pf = p.dataset.fields.split(',').map(s => s.trim());
      if (pf.includes(f.dataset.name)) p.classList.add('hl');
    });
  });
  f.addEventListener('mouseleave', () => { if (!formActive && !impactLocked) resetAll(); });
});

// ── Source Card Data ──

// ── State Law Data Model ──

const STATE_LAW_DATA = {
  MA: {
    name: 'Massachusetts',
    abbr: 'MA',
    sources: [
      { name: 'MA AG Healthcare Division', desc: 'AG jurisdiction over healthcare market consolidation, annual cost trends reports showing independent vs system cost data', url: 'https://www.mass.gov/orgs/attorney-generals-health-care-division' },
      { name: 'MA Health Policy Commission', desc: 'State body reviewing healthcare market consolidation. Publishes detailed cost/quality data, provider price variation reports.', url: 'https://www.mass.gov/orgs/health-policy-commission' },
      { name: 'CHIA (Center for Health Info & Analysis)', desc: 'MA All-Payer Claims Database (APCD), provider price variation data, market analytics. APCD requires data use agreement.', url: 'https://www.chiamass.gov' },
      { name: 'Chapter 224 Cost Containment', desc: 'MA cost containment law — sets healthcare cost growth benchmark, requires reporting from providers and payers.', url: 'https://malegislature.gov/Laws/SessionLaws/Acts/2012/Chapter224' },
      { name: 'MA Division of Insurance', desc: 'TPA licensing requirements, network adequacy rules for self-insured plans.', url: 'https://www.mass.gov/orgs/division-of-insurance' },
      { name: 'MA Board of Registration in Medicine', desc: 'Physician credential verification and disciplinary history lookup.', url: 'https://www.massmedboard.org/public/physician-lookup' },
      { name: 'MA General Laws Ch. 176D', desc: 'Unfair insurance practices — governs TPA conduct and claims handling.', url: 'https://malegislature.gov/Laws/GeneralLaws/PartI/TitleXXII/Chapter176D' },
      { name: 'MA General Laws Ch. 175', desc: 'Insurance licensing — requirements for entities facilitating health plan transactions.', url: 'https://malegislature.gov/Laws/GeneralLaws/PartI/TitleXXII/Chapter175' }
    ]
  }
};

function renderStateLawChildren() {
  const container = document.getElementById('state-law-children');
  const states = Object.keys(STATE_LAW_DATA);
  document.getElementById('state-law-badge').textContent = states.length + (states.length === 1 ? ' state' : ' states');
  let html = '';
  states.forEach(abbr => {
    const st = STATE_LAW_DATA[abbr];
    html += `<div class="state-law-state" onclick="openStateLawCard('${abbr}')">
      <span class="sls-name">${st.abbr} — ${st.name}</span>
      <span class="sls-count">${st.sources.length} sources</span>
    </div>`;
  });
  container.innerHTML = html;
}

function toggleStateLaw(e) {
  e.stopPropagation();
  document.getElementById('state-law-row').classList.toggle('expanded');
}

function openStateLawCard(abbr) {
  const st = STATE_LAW_DATA[abbr];
  if (!st) return;
  const overlay = document.getElementById('source-overlay');
  const panel = document.getElementById('source-panel');
  sourcePanelOpen = true;

  let html = '<div class="src-card-header">';
  html += '<div class="src-card-header-info">';
  html += `<div class="src-card-title">State Law — ${st.name}</div>`;
  html += `<div class="src-card-agency">${st.sources.length} regulatory sources mapped</div>`;
  html += '</div>';
  html += '<button class="detail-close" onclick="closeSourceCard()">&times;</button>';
  html += '</div>';

  html += '<div class="src-card-body">';
  html += '<div class="src-card-stat-row">';
  html += `<div class="src-card-stat"><div class="src-card-stat-val">${st.sources.length}</div><div class="src-card-stat-label">Sources</div></div>`;
  html += '<div class="src-card-stat"><div class="src-card-stat-val"><span class="src-card-pill pill-free">Free / Public</span></div><div class="src-card-stat-label">Cost</div></div>';
  html += '<div class="src-card-stat"><div class="src-card-stat-val">PDF / Web</div><div class="src-card-stat-label">Format</div></div>';
  html += '</div>';

  html += '<div class="src-card-divider"></div>';

  st.sources.forEach((src, i) => {
    html += '<div style="margin-bottom:12px;">';
    html += `<div style="font-size:10px;font-weight:700;color:#283593;margin-bottom:3px;">${i+1}. ${src.name}</div>`;
    html += `<div style="font-size:9px;color:#555;line-height:1.5;margin-bottom:4px;">${src.desc}</div>`;
    if (src.url) html += `<div style="font-size:9px;"><a href="${src.url}" target="_blank" style="color:#4f46e5;text-decoration:none;border-bottom:1px dashed #c7d2fe;word-break:break-all;">${src.url}</a></div>`;
    html += '</div>';
  });

  html += '<div class="src-card-divider"></div>';
  html += '<div class="src-card-row">';
  html += '<div class="src-card-label">AWS Lake</div>';
  html += '<div class="src-card-value">State regulatory documents stored in S3 under s3://meroka-legal/{state}/. PDF text extracted and chunked for RAG retrieval. Vector embeddings indexed for Claude context injection.</div>';
  html += '</div>';

  html += '<div class="src-card-row">';
  html += '<div class="src-card-label">Notes</div>';
  html += '<div class="src-card-value"><div class="src-card-note">Legal knowledge base built for RAG — source documents ingested, chunked (~500 tokens), embedded, and stored in vector DB. Claude retrieves relevant chunks when drafting contracts and compliance docs. Output is informational — does not replace legal counsel.</div></div>';
  html += '</div>';

  html += '</div>';
  panel.innerHTML = html;
  overlay.classList.add('open');
}

const SOURCE_CARDS = {
  nppes: {
    name: 'NPPES — National Plan & Provider Enumeration System',
    agency: 'Centers for Medicare & Medicaid Services (CMS)',
    url: 'https://download.cms.gov/nppes/NPI_Files.html',
    apiUrl: 'https://npiregistry.cms.hhs.gov/api/?version=2.1',
    format: 'CSV (bulk ~9 GB uncompressed), JSON API',
    structure: 'One row per NPI. 330+ columns: NPI, entity type, provider name, addresses, up to 15 taxonomy codes, enumeration/deactivation dates, authorized official fields.',
    frequency: 'Monthly (full file), Weekly (incremental)',
    records: '~8–9 million NPIs',
    access: 'Direct download — no account or API key required',
    cost: 'free',
    lakeOrg: 'S3 bucket partitioned by state, indexed on NPI. Raw CSV → Parquet via AWS Glue.',
    notes: 'File too large for Excel. API max 200 results/query (lookup only, not bulk). Deactivated NPIs remain in file. Version 2 effective 03/2026 with extended field lengths.'
  },
  pecos: {
    name: 'CMS PECOS — Provider Enrollment, Chain & Ownership',
    agency: 'Centers for Medicare & Medicaid Services (CMS)',
    url: 'https://data.cms.gov/provider-characteristics/medicare-provider-supplier-enrollment/medicare-fee-for-service-public-provider-enrollment',
    format: 'CSV, API (data.cms.gov)',
    structure: 'Enrollment records: NPI, legal name, enrollment type, provider specialty, reassignment info, practice location (city/state/ZIP).',
    frequency: 'Quarterly',
    records: '~1.5–2 million enrolled providers',
    access: 'Direct download — no account needed',
    cost: 'free',
    lakeOrg: 'Quarterly snapshots in S3 as Parquet, keyed on NPI + enrollment type.',
    notes: 'Subset of full PECOS data. Only city/state/ZIP (no street addresses). Reflects actual Medicare enrollment status, not just NPI registration.'
  },
  pos: {
    name: 'CMS Provider of Services File',
    agency: 'Centers for Medicare & Medicaid Services (CMS)',
    url: 'https://data.cms.gov/provider-characteristics/hospitals-and-other-facilities/provider-of-services-file-hospital-non-hospital-facilities',
    format: 'CSV, JSON API',
    structure: 'One record per Medicare-certified provider (CCN). Certification info, ownership type, bed size, accreditation, teaching status, services. 3 files: Hospital/Non-Hospital, CLIA labs, iQIES (HHA/ASC/Hospice).',
    frequency: 'Quarterly',
    records: '~100K providers + 300K labs',
    access: 'Direct download — no account needed',
    cost: 'free',
    lakeOrg: 'Quarterly snapshots in S3 keyed on CCN. Joined with NPPES for NPI cross-reference.',
    notes: 'Point-in-time snapshot file. iQIES split from "OTHER" in Q4 2023. CMS retiring SAS format after April 2026.'
  },
  clia: {
    name: 'CMS CLIA Labs — Clinical Laboratory Certification',
    agency: 'Centers for Medicare & Medicaid Services (CMS)',
    url: 'https://data.cms.gov/provider-characteristics/hospitals-and-other-facilities/provider-of-services-file-clinical-laboratories',
    apiUrl: 'https://qcor.cms.gov/basic_research.jsp',
    format: 'CSV (~156 MB), JSON API (no key required)',
    structure: 'One record per CLIA-certified lab. Fields: CLIA number, facility name, address, certificate type (Waiver, PPM, Compliance, Accreditation), lab status, ownership type, facility type (physician office, hospital, independent, FQHC, pharmacy, etc.), testing specialties, specimen volume, accrediting org.',
    frequency: 'Quarterly',
    records: '~244,000 lab records',
    access: 'Direct download from data.cms.gov — no account needed. API available. Individual lookups via QCOR.',
    cost: 'free',
    lakeOrg: 'Quarterly snapshots in S3 keyed on CLIA number. Linked to NPPES via address matching for NPI cross-reference.',
    notes: 'Most RHCs hold a Certificate of Waiver (for CLIA-waived tests) or PPM certificate. Facility type code 21 = Physician Office, 09 = FQHC, 06 = Community Clinic. NBER also provides reformatted versions in SAS/Stata.'
  },
  hrsa: {
    name: 'HRSA — Federally Qualified Health Centers',
    agency: 'Health Resources & Services Administration (HRSA)',
    url: 'https://data.hrsa.gov/data/download',
    apiUrl: 'https://data.hrsa.gov/data/reports/datagrid?gridName=FQHCs',
    format: 'XLSX, CSV, ASCII, SAS',
    structure: 'Health center org-level data: name, address, grant number, FQHC designation, services. UDS tables: patient demographics, clinical measures, staffing, financials, utilization.',
    frequency: 'Annually (UDS), rolling (site listings)',
    records: '~1,400 orgs / 15,000+ sites / 32M patients',
    access: 'Direct download. Granular UDS data may require FOIA.',
    cost: 'free',
    lakeOrg: 'Annual UDS snapshots in S3 + site-level records partitioned by state.',
    notes: 'UDS data has 6-12 month lag. Not all HRSA sites are CMS-certified FQHCs. HRSA Geospatial Warehouse provides geocoded locations.'
  },
  hpsa_mua: {
    name: 'HRSA HPSA / MUA Designations',
    agency: 'Health Resources & Services Administration (HRSA)',
    url: 'https://data.hrsa.gov/data/download',
    apiUrl: 'https://data.hrsa.gov/tools/shortage-area/by-address',
    format: 'CSV/XLSX (bulk download), interactive web tool',
    structure: 'Health Professional Shortage Areas (HPSA): designation type (primary care, dental, mental health), HPSA score (1-25), geographic area, population served, provider-to-population ratio. Medically Underserved Areas (MUA/MUP): Index of Medical Underservice score, designation type, geographic boundaries.',
    frequency: 'Rolling (designations reviewed on application/renewal)',
    records: '~7,000+ HPSA designations, ~4,000+ MUA/MUP designations',
    access: 'Bulk download from data.hrsa.gov (Health Workforce section) — no account needed. Address-level lookup tool available.',
    cost: 'free',
    lakeOrg: 'HPSA and MUA boundaries in S3, geocoded to census tracts. Lookup table by ZIP for quick eligibility checks.',
    notes: 'A practice must be in a HPSA or MUA to qualify for RHC certification. HPSA score (1-25) determines priority for National Health Service Corps placements. Designations can be geographic, population-based, or facility-based. Use the "Am I Rural?" tool at ruralhealthinfo.org for quick checks.'
  },
  ruca: {
    name: 'USDA RUCA Codes — Rural-Urban Classification',
    agency: 'USDA Economic Research Service (ERS)',
    url: 'https://www.ers.usda.gov/data-products/rural-urban-commuting-area-codes',
    apiUrl: 'https://www.ruralhealthinfo.org/am-i-rural',
    format: 'XLSX (ZIP code and census tract versions)',
    structure: 'ZIP-to-RUCA mapping. Primary codes 1-10: 1=Metro core, 2-3=Metro commuting, 4=Micro core, 5-6=Micro commuting, 7=Small town core, 8-9=Small town commuting, 10=Rural. Secondary decimal codes for commuting flow detail. Includes population, land area, population density.',
    frequency: 'Decennial (updated with each Census; current version uses 2020 Census, updated Aug 2025)',
    records: '~42,000 ZIP codes mapped',
    access: 'Direct download from USDA ERS — no account needed',
    cost: 'free',
    lakeOrg: 'ZIP-to-RUCA lookup table in S3. Joined with NPPES practice addresses for rurality classification.',
    notes: 'RUCA >= 4 is the standard threshold for "non-urbanized" in RHC eligibility. The WWAMI RHRC (Univ. of Washington) provides an alternative ZIP-RUCA crosswalk. Errata correction issued Dec 2025. For CMS RHC purposes, the Census urbanized area definition is the official standard, but RUCA is the best proxy at ZIP level.'
  },
  census_ua: {
    name: 'Census Bureau Urban Area Boundaries',
    agency: 'U.S. Census Bureau',
    url: 'https://www.census.gov/programs-surveys/geography/guidance/geo-areas/urban-rural.html',
    apiUrl: 'https://geocoding.geo.census.gov/geocoder/',
    format: 'Shapefile (SHP), TIGER/Line files, Geocoder API',
    structure: 'Urban area boundary polygons for 2,645 urban areas (2020 Census). Urban areas defined as ≥2,000 housing units or ≥5,000 population. Includes urban area name, type (urbanized area vs. urban cluster), land area, population. Relationship files map census blocks to urban areas.',
    frequency: 'Decennial (2020 Census boundaries; next update after 2030 Census)',
    records: '2,645 urban areas defined',
    access: 'Direct download from Census TIGER/Line. Geocoder API is free — no key needed.',
    cost: 'free',
    lakeOrg: 'Urban area shapefiles in S3. Point-in-polygon lookups to flag each practice address as urbanized or non-urbanized.',
    notes: 'CMS uses the Census urbanized area definition as the official test for RHC rural eligibility — a practice must NOT be in an urbanized area. The Census Geocoder can geocode an address to a census block, which can then be checked against urban area boundaries. TIGER/Line shapefiles are large but well-documented.'
  },
  medicare_util: {
    name: 'Medicare Physician Utilization & Payment',
    agency: 'Centers for Medicare & Medicaid Services (CMS)',
    url: 'https://data.cms.gov/provider-summary-by-type-of-service/medicare-physician-other-practitioners',
    format: 'Tab-delimited CSV, JSON API',
    structure: 'One row per NPI × HCPCS × place of service. Provider demographics, utilization counts (services, beneficiaries), payment data (submitted charges, allowed amounts, Medicare payments).',
    frequency: 'Annually (1-2 year lag)',
    records: '~10M+ rows/year',
    access: 'Direct download — no account needed',
    cost: 'free',
    lakeOrg: 'Annual partitions in S3. Provider-level and service-level aggregations via Athena.',
    notes: 'Medicare Fee-For-Service only — no Medicare Advantage, Medicaid, or commercial. Records with <11 beneficiaries are suppressed. CPT codes copyrighted by AMA.'
  },
  tic: {
    name: 'Transparency in Coverage (TiC) Machine-Readable Files',
    agency: 'Mandated by CMS / HHS / DOL — published by each health insurer',
    url: 'https://github.com/CMSgov/price-transparency-guide',
    format: 'JSON (compressed .gz/.zip) — terabyte-scale',
    structure: 'Per insurer: In-Network Rate Files (negotiated rates by NPI × CPT × place of service), Allowed Amount Files (out-of-network), Prescription Drug Files. Linked by Table of Contents JSON.',
    frequency: 'Monthly (required by regulation)',
    records: 'Billions of rate records across all insurers',
    access: 'Free HTTPS download from each insurer\'s site. No central registry.',
    cost: 'free',
    lakeOrg: 'Streaming JSON parse (ijson). Normalized to NPI × CPT rate rows in S3 Parquet. Partitioned by insurer and state.',
    notes: 'Files are massive (single insurer can be 2+ TB). Requires streaming JSON parsers. Data quality varies by insurer. Schema 2.0 effective Feb 2026. Third-party aggregators: Serif Health, Turquoise Health.'
  },
  fair_health: {
    name: 'FAIR Health — National Private Insurance Claims',
    agency: 'FAIR Health, Inc. (independent nonprofit, est. 2009)',
    url: 'https://www.fairhealth.org/',
    apiUrl: 'https://www.fairhealthconsumer.org/',
    format: 'Licensed REST API (JSON)',
    structure: 'Cost benchmarks by CPT/HCPCS code × 3-digit ZIP ("geozip") × percentile. Charge benchmarks (what providers bill) and allowed benchmarks (what insurers pay). 15,000+ procedure codes.',
    frequency: 'Semi-annual benchmark updates',
    records: '57B+ commercial + 53B+ Medicare claim records, ~150M lives',
    access: 'License agreement required. Contact service@fairhealth.org',
    cost: 'paid',
    lakeOrg: 'API responses cached in S3/Athena by CPT × geozip. Refreshed semi-annually.',
    notes: 'Not publicly accessible in bulk. NCQA-certified. Covers ~75% of privately insured U.S. population. Data back to 2002. Heavily used in litigation and out-of-network reimbursement.'
  },
  meps: {
    name: 'MEPS — Medical Expenditure Panel Survey',
    agency: 'Agency for Healthcare Research & Quality (AHRQ)',
    url: 'https://meps.ahrq.gov/data_stats/download_data_files.jsp',
    format: 'SAS, Stata, ASCII, XLSX',
    structure: 'Household Component: person-level data (1,400+ variables) — demographics, conditions, insurance, utilization, expenditures. Sub-files: office visits, ER, inpatient, prescriptions, dental.',
    frequency: 'Annually (~2 year lag)',
    records: '~22K–35K persons/year (nationally representative)',
    access: 'Direct download. Restricted files require AHRQ Data Center access.',
    cost: 'free',
    lakeOrg: 'Annual person-level files in S3 with survey weights preserved. Event files linked by DUPERSID.',
    notes: 'Survey data — must use provided weights for national estimates. Civilian noninstitutionalized population only. Variable names can change across years.'
  },
  rand: {
    name: 'RAND / Sage Transparency — Hospital Pricing',
    agency: 'RAND Corporation + Employer Price Transparency Project',
    url: 'https://employerptp.org/sage-transparency/',
    apiUrl: 'https://www.hospitaldatasets.org/',
    format: 'Web dashboard (Tableau), CSV (HCRIS data)',
    structure: 'Hospital-level commercial prices as % of Medicare. Inpatient/outpatient/professional breakdowns. HCRIS: ~1,500 fields from CMS cost reports (revenue, cost, utilization, charges).',
    frequency: 'Quarterly (HCRIS), biennial (study rounds)',
    records: '4,000+ hospitals, 2,000+ ASCs',
    access: 'Sage browsing free. Data purchasable. HCRIS freely downloadable.',
    cost: 'free',
    lakeOrg: 'HCRIS quarterly imports in S3 keyed on provider number. Sage benchmarks as supplementary reference table.',
    notes: 'Headline finding: commercial insurers pay ~254% of Medicare rates. Sage data from employer claims + state APCDs — not all payers. Study round 6 expected Sept 2027.'
  },
  mips: {
    name: 'MIPS / QPP — Quality Payment Program',
    agency: 'Centers for Medicare & Medicaid Services (CMS)',
    url: 'https://qpp.cms.gov/',
    apiUrl: 'https://data.cms.gov/provider-data/search?keyword=MIPS',
    format: 'CSV, JSON API (no key required)',
    structure: 'Per clinician-group: Final Score, Quality/Cost/Promoting Interoperability/Improvement Activities scores. Measures file: one row per clinician × measure with detailed performance.',
    frequency: 'Annually (~18 month lag)',
    records: '~700K–900K clinician records',
    access: 'Direct download from data.cms.gov — no account needed',
    cost: 'free',
    lakeOrg: 'Annual snapshots in S3 keyed on NPI × TIN. Score history table for longitudinal tracking.',
    notes: 'PY2023 is most recent public data. Payment adjustments range -9% to +9%. Transitioning toward MIPS Value Pathways (MVPs). Not all clinicians are MIPS-eligible.'
  },
  care_compare: {
    name: 'CMS Care Compare — Provider Data Catalog',
    agency: 'Centers for Medicare & Medicaid Services (CMS)',
    url: 'https://data.cms.gov/provider-data/',
    apiUrl: 'https://www.medicare.gov/care-compare/',
    format: 'CSV (bulk), JSON API (no key, 1,000 rows/request)',
    structure: 'Datasets by type: Hospitals (quality, HCAHPS, infections, readmissions), Nursing Homes (inspections, staffing, penalties), Doctors (MIPS, affiliations), Home Health, Hospice, Dialysis.',
    frequency: 'Quarterly (most datasets)',
    records: '~5K hospitals, ~15K nursing homes, ~1.3M clinicians',
    access: 'Direct download + API — no registration needed',
    cost: 'free',
    lakeOrg: 'Quarterly snapshots in S3 per provider type. Hospital and clinician tables joined with NPPES/PECOS.',
    notes: 'Replaced legacy Hospital Compare / Physician Compare. API returns max 1,000 rows (use offset pagination). Data dictionaries are PDFs — critical for field understanding.'
  },
  leapfrog: {
    name: 'Leapfrog Hospital Safety Grades',
    agency: 'The Leapfrog Group (independent nonprofit)',
    url: 'https://www.hospitalsafetygrade.org/',
    format: 'Web lookup (free), Excel/API (licensed)',
    structure: 'Letter grade (A–F) per hospital + 32 underlying safety measures: infections, PSI-90 composite, practices to prevent errors. Sourced from Leapfrog Survey, AHRQ, CDC, CMS.',
    frequency: 'Semi-annual (Spring + Fall)',
    records: '~3,000 general acute care hospitals',
    access: 'Free public lookup. Enterprise: subscription for bulk data + API via The Hopper.',
    cost: 'paid',
    lakeOrg: 'Semi-annual grade snapshots in S3 per hospital. Historical grade tracking for trend analysis.',
    notes: 'Only general acute care hospitals (excludes VA, critical access, specialty, children\'s). Only 12% of hospitals sustained an "A" for 5+ consecutive rounds. Methodology is publicly downloadable.'
  },
  med_boards: {
    name: 'State Medical Boards (FSMB)',
    agency: 'Federation of State Medical Boards + 50 individual state boards',
    url: 'https://www.fsmb.org/PDC/',
    format: 'REST API (JSON), bulk data files',
    structure: 'Standard profile: biographical info, license history (all states), education, national IDs (NPI, DEA). Premium: adds ABMS board certification. Bulk files for sanctions and licensing.',
    frequency: 'Monthly (licensure & disciplinary updates)',
    records: '1M+ physician and PA profiles',
    access: 'Account required. Email pdc@fsmb.org for API credentials.',
    cost: 'paid',
    lakeOrg: 'Monthly license snapshots in S3 keyed on NPI. Sanction events as append-only log.',
    notes: '$9/physician (standard), $12 (premium). Only centralized multi-state source. NCQA-certified primary-source verification. Only MDs, DOs, and PAs — no nurses/pharmacists. Free state-by-state lookups exist but require 50+ separate systems.'
  },
  website: {
    name: 'Practice Websites (Web Scraping)',
    agency: 'Self-published by individual medical practices',
    url: null,
    format: 'Unstructured HTML, occasional Schema.org JSON-LD',
    structure: 'Provider names, specialties, credentials, bios, office locations, phone, hours, accepted insurance, services, conditions treated, appointment links, ownership info.',
    frequency: 'Varies (weeks to years per site)',
    records: '~250K+ medical practice websites',
    access: 'Custom web scrapers (Scrapy, Playwright). Public sites — no auth.',
    cost: 'free',
    lakeOrg: 'Scraped HTML stored in S3. Parsed fields in structured tables by practice via Glue ETL.',
    notes: 'No standardization — every site is different. Common platforms (WordPress, Squarespace) provide some consistency. High maintenance cost: sites change frequently. Respect robots.txt. PE-owned practices may reveal corporate parent in site footer.'
  },
  google: {
    name: 'Google Business Profiles',
    agency: 'Google (Alphabet Inc.)',
    url: 'https://developers.google.com/maps/documentation/places/web-service',
    format: 'REST API (JSON, OAuth/API key)',
    structure: 'Per listing: name, address, phone, website, hours, category, coordinates, star rating, review count, review text, photos. Healthcare-specific: wheelchair access, languages, insurance accepted, telehealth, provider gender.',
    frequency: 'Real-time (continuously updated)',
    records: 'Hundreds of thousands of healthcare listings',
    access: 'Places API: Google Cloud project + API key. Pay-per-use.',
    cost: 'paid',
    lakeOrg: 'API responses cached in S3 with TTL. Review snapshots taken monthly. Keyed on Place ID + NPI cross-ref.',
    notes: 'Places API is the only legal method — scraping prohibited. Field masks critical for cost control (request only needed fields). 77% of patients start healthcare search via Google. GBP Management API only for your own listings.'
  },
  healthgrades: {
    name: 'Healthgrades / Vitals',
    agency: 'RVO Health (Red Ventures + Optum/UHG) / WebMD (Internet Brands)',
    url: 'https://www.healthgrades.com/',
    format: 'No official API — web scraping or third-party services',
    structure: '3M+ provider profiles: name, specialty, board certs, hospital affiliations, addresses, insurance, ratings (1–5), reviews, experience years, education, conditions/procedures, disciplinary actions. ~4,500 hospital quality evaluations.',
    frequency: 'Continuous (sourced from NPI Registry, surveys, claims)',
    records: '3M+ providers, 4,500 hospitals',
    access: 'Free browse. No official bulk API. Third-party scrapers: Apify, Datashake.',
    cost: 'restricted',
    lakeOrg: 'Scraped profiles stored in S3 by NPI. Review text and ratings in separate review table.',
    notes: 'No public API — monetized through advertising. Scraping may violate ToS. Auto-creates profiles for every NPI. Vitals (now under WebMD) has quality concerns (AI-generated photos, suppressed reviews). Parent company Optum creates conflict of interest.'
  },
  linkedin: {
    name: 'LinkedIn',
    agency: 'LinkedIn Corporation (Microsoft)',
    url: 'https://www.linkedin.com/',
    format: 'REST API (JSON, OAuth 2.0) — Partner access only',
    structure: 'Professional profiles: name, headline, positions (employer, title, dates), education (med school, residency, fellowship), skills, certifications, company pages (employee count, founding date).',
    frequency: 'Real-time (user-maintained)',
    records: '1B+ global members, ~1M+ U.S. physicians estimated',
    access: 'Official API requires LinkedIn Partner approval (extremely restricted). Scraping prohibited with aggressive enforcement.',
    cost: 'restricted',
    lakeOrg: 'If obtained: employment history in S3 keyed on NPI or name match. Employer transitions flagged for PE acquisition detection.',
    notes: 'Most legally aggressive platform against scraping. Work history moved behind login wall (late 2025). Valuable for PE-physician relationship detection. Consider ZoomInfo/Apollo as alternative aggregators. Sales Navigator or Recruiter licenses as fallback.'
  },
  sos: {
    name: 'SEC EDGAR + State Secretary of State Filings',
    agency: 'SEC + 50 State Secretaries of State',
    url: 'https://www.sec.gov/edgar/',
    format: 'SEC: REST API (JSON, XBRL). State SoS: HTML/CSV/API (varies)',
    structure: 'SEC EDGAR: 10-K, 8-K, 13-F, SC 13D filings. Entity metadata: name, SIC code, state of incorporation. State SoS: entity name, type (LLC/Corp), status, formation date, registered agent, officers.',
    frequency: 'SEC: real-time (~4,700 filings/day). State SoS: daily to monthly.',
    records: 'SEC: 800K+ entities, 18M+ filings. SoS: tens of millions across all states.',
    access: 'SEC: free, no key (10 req/sec, User-Agent header required). State SoS: free individual lookup; bulk data $0–$9,500+ per state.',
    cost: 'free',
    lakeOrg: 'SEC filings in S3 indexed by CIK. State entity records deduplicated by name + registered agent. Cross-referenced to identify PE holding structures.',
    notes: 'Most healthcare practices are private (not in SEC). SEC useful for PE firms and publicly traded health systems. 8-K filings can reveal practice acquisitions. No federal centralized business registry. Delaware is critical for PE structures but provides minimal public data. OpenCorporates aggregates many states.'
  },
  form5500: {
    name: 'DOL Form 5500 — Employee Benefit Plans',
    agency: 'U.S. Department of Labor (EBSA)',
    url: 'https://www.dol.gov/agencies/ebsa/about-ebsa/our-activities/public-disclosure/foia/form-5500-datasets',
    apiUrl: 'https://www.efast.dol.gov/5500Search/',
    format: 'Zipped CSV (multi-table relational)',
    structure: 'Main form + schedule tables linked by ACK_ID. Key fields: plan name, sponsor name/EIN, plan type (pension/welfare), participant count, total assets, contributions, benefits paid, service providers, insurance info.',
    frequency: 'Annually',
    records: '~800K plans file annually',
    access: 'Direct download — no account needed',
    cost: 'free',
    lakeOrg: 'Latest-filing extracts in S3 keyed on plan sponsor EIN. Joined with employer records for self-funded plan identification.',
    notes: 'Complex relational structure — join on ACK_ID. Use "Latest" dataset (not "All") to avoid amended duplicates. Self-reported and not audited. Form 5500-EZ (one-participant plans) filed with IRS, not included here.'
  },
  gao: {
    name: 'GAO Market Concentration Reports',
    agency: 'Government Accountability Office + ASPE/HHS + MedPAC',
    url: 'https://www.gao.gov/products/gao-25-107450',
    format: 'PDF reports (no structured dataset)',
    structure: 'HHI indices for hospital, physician, and insurer markets by MSA. Consolidation trends (47% of physicians with hospitals in 2024, ~6.5% under PE). Price/spending effect estimates from literature review.',
    frequency: 'Ad hoc (congressional request basis)',
    records: 'N/A — analytical reports, not row-level data',
    access: 'Direct download of PDFs — no account needed',
    cost: 'free',
    lakeOrg: 'ASPE MSA-level HHI values extracted from PDF tables and stored in S3 as reference data.',
    notes: 'No structured downloadable dataset — findings within PDF reports require manual or PDF-parse extraction. Underlying data (IQVIA, SK&A) is proprietary and expensive. ASPE environmental scan provides best structured HHI by MSA.'
  },
  ai_classifier: {
    name: 'AI Independence Classifier',
    agency: 'Internal (Meroka)',
    url: null,
    format: 'Internal model output (JSON)',
    structure: 'Per practice: independence classification (Independent / PE-backed / System-Affiliated / FQHC / Academic / Unknown), confidence score, contributing signals, classification date.',
    frequency: 'Pipeline-defined (batch daily or on-demand)',
    records: 'Target universe: ~200K+ practices',
    access: 'Internal API / BigQuery',
    cost: 'free',
    lakeOrg: 'Classification results in S3 (raw) and BigQuery (serving). Full signal lineage. Versioned by model iteration.',
    notes: 'Only as good as upstream sources. Ground truth labels are scarce — PE ownership often not publicly disclosed. Low-confidence results flagged for manual review. Temporal lag: a practice acquired last month may not yet show in public records.'
  },
  pe_list: {
    name: 'Known PE Platforms — Private Equity Tracker',
    agency: 'PESP (nonprofit), PitchBook (Morningstar), Becker\'s Healthcare',
    url: 'https://pestakeholder.org/private-equity-hospital-tracker/',
    format: 'Web dashboard (PESP), proprietary platform (PitchBook)',
    structure: 'Per PE platform: PE firm, fund, platform name, specialty vertical, location count, geographic footprint, deal type, transaction date. PESP: ~488 hospitals, 420+ platforms, 1,029 deals across 708 firms.',
    frequency: 'PESP: periodic (last Aug 2025). PitchBook: daily.',
    records: '488 PE-owned hospitals + 420+ platforms tracked',
    access: 'PESP: free public web. PitchBook: paid enterprise subscription ($20K–$50K+/yr).',
    cost: 'free',
    lakeOrg: 'PE platform reference table in S3 with firm/platform/specialty/geography. Updated from PESP + manual curation.',
    notes: 'No single authoritative PE registry. PE ownership often obscured through holding company layers. Key specialties: dental (132 deals in 2024), behavioral health, dermatology, ophthalmology. Regulatory landscape shifting — 35+ states now require notification of PE healthcare transactions.'
  },
  derived: {
    name: 'Derived & Calculated Fields',
    agency: 'Internal (Meroka)',
    url: null,
    format: 'BigQuery tables / internal API',
    structure: 'Computed from upstream sources: Price Competitiveness Score, Safety/Quality Composite, Patient Sentiment Score, Independence Score, Provider Completeness Score, Practice Size Estimate, PE Ownership Flag, Geographic Access Metrics.',
    frequency: 'Aligned with slowest upstream source',
    records: 'Mirrors entity universe (one per provider/practice)',
    access: 'Internal BigQuery / API',
    cost: 'free',
    lakeOrg: 'Raw derivations in S3, materialized views in BigQuery. Source lineage metadata. Versioned by pipeline run.',
    notes: 'Derived fields inherit upstream limitations. Document all derivation logic and source versions. Combine data with different cadences carefully — timestamp derivations and flag staleness. Verify upstream licenses permit derivative works.'
  },
  aks: {
    name: 'Anti-Kickback Statute (AKS)',
    agency: 'HHS Office of Inspector General (OIG)',
    url: 'https://www.law.cornell.edu/uscode/text/42/1320a-7b',
    apiUrl: 'https://oig.hhs.gov/compliance/safe-harbor-regulations/',
    format: 'Legal statute text, Federal Register rules, OIG Advisory Opinions (PDF)',
    structure: 'Prohibits remuneration arrangements that induce referrals for federal healthcare program services. Key safe harbors for Meroka: personal services & management contracts, fair market value compensation, value-based care (2021). OIG advisory opinions provide case-specific guidance on CINs, gainsharing, and direct contracting.',
    frequency: 'Statute is permanent; safe harbors updated periodically; advisory opinions issued on request',
    records: 'N/A — legal text + ~200 advisory opinions',
    access: 'Free — statute on Cornell LII, safe harbors on OIG website, advisory opinions searchable',
    cost: 'free',
    lakeOrg: 'PDF text extracted and chunked for RAG in S3. Safe harbor text indexed separately for precise retrieval. Advisory opinions tagged by topic (CIN, gainsharing, VBC).',
    notes: 'The 2021 value-based care safe harbors are the most critical for Meroka\'s model — they were specifically designed for arrangements like direct contracting. Three tiers: care coordination (low risk), substantial downside risk, and full financial risk. Criminal statute — violations carry up to 10 years imprisonment.'
  },
  stark: {
    name: 'Stark Law — Physician Self-Referral',
    agency: 'Centers for Medicare & Medicaid Services (CMS)',
    url: 'https://www.law.cornell.edu/uscode/text/42/1395nn',
    apiUrl: 'https://www.cms.gov/Medicare/Fraud-and-Abuse/PhysicianSelfReferral',
    format: 'Legal statute text, CMS Final Rules (Federal Register), FAQ documents (PDF)',
    structure: 'Prohibits physician referrals for designated health services (DHS) to entities with financial relationships — unless an exception applies. Key exceptions for Meroka: personal services, fair market value, value-based arrangements (2021), group practice. CMS FAQ provides interpretive guidance.',
    frequency: 'Statute is permanent; 2021 final rule added VBC exceptions',
    records: 'N/A — legal text + CMS guidance docs',
    access: 'Free — statute on Cornell LII, final rules on Federal Register, FAQ on CMS website',
    cost: 'free',
    lakeOrg: 'Exceptions text extracted and indexed in S3 for RAG. 2021 final rule chunked with cross-references to AKS safe harbors.',
    notes: 'Civil (not criminal) statute — but violations trigger False Claims Act liability. The 2021 value-based arrangements exception mirrors the AKS safe harbors and significantly reduces compliance burden for CIN-based direct contracting.'
  },
  erisa: {
    name: 'ERISA — Employee Retirement Income Security Act',
    agency: 'U.S. Department of Labor (DOL)',
    url: 'https://www.law.cornell.edu/uscode/text/29/chapter-18',
    apiUrl: 'https://www.dol.gov/agencies/ebsa/laws-and-regulations/laws/erisa',
    format: 'Legal statute text, DOL guidance documents, FAQs (PDF)',
    structure: 'Governs self-insured employer health plans — Meroka\'s employer clients. ERISA preempts most state insurance law, giving self-insured employers more flexibility to direct contract. Key provisions: Section 3(1) plan definitions, SPD requirements for adding direct contract arrangements, fiduciary duty when steering employees to specific providers.',
    frequency: 'Statute is permanent; DOL guidance updated periodically',
    records: 'N/A — legal text + DOL guidance',
    access: 'Free — statute on Cornell LII, guidance on DOL EBSA website',
    cost: 'free',
    lakeOrg: 'ERISA plan amendment templates and fiduciary duty rules in S3. Cross-referenced with Form 5500 data for employer plan identification.',
    notes: 'ERISA preemption is key — self-insured employers are NOT subject to state insurance mandates, which is why direct contracting bypassing traditional insurance networks is legally viable. Fiduciary duty requires employers to act prudently when directing employees to specific providers.'
  },
  vbc_safe_harbors: {
    name: 'Value-Based Care Safe Harbors (2021)',
    agency: 'HHS Office of Inspector General (OIG) + CMS',
    url: 'https://www.federalregister.gov/documents/2020/12/02/2020-26072/medicare-and-state-health-care-programs-fraud-and-abuse-protections-for-value-based-arrangements',
    format: 'Federal Register final rule (PDF, ~300 pages)',
    structure: 'Three new AKS safe harbors + three new Stark exceptions for value-based arrangements: (1) Care coordination arrangements (low risk), (2) Value-based arrangements with substantial downside risk, (3) Full financial risk arrangements. Defines "value-based enterprise," "value-based purpose," and "VBE participant." Includes detailed examples.',
    frequency: 'Effective Jan 19, 2021; permanent until amended',
    records: 'N/A — single final rule document',
    access: 'Free — Federal Register, OIG website',
    cost: 'free',
    lakeOrg: 'Full rule text in S3, chunked by safe harbor tier. Definition sections and examples indexed separately for precise RAG retrieval.',
    notes: 'The single most important federal development for Meroka\'s legal model. These safe harbors were specifically designed to enable arrangements where providers and payers (including self-insured employers via VBEs) share accountability for cost and quality. A CIN qualifies as a "value-based enterprise" under these rules.'
  },
  ftc_cin: {
    name: 'FTC/DOJ CIN & Antitrust Guidelines',
    agency: 'Federal Trade Commission + Department of Justice',
    url: 'https://www.ftc.gov/sites/default/files/documents/public_events/joint-venture-hearings-antitrust-guidelines-collaboration-among-competitors/ftcdojguidelines.pdf',
    apiUrl: 'https://www.ftc.gov/advice-guidance/competition-guidance/industry-guidance/health-care',
    format: 'Policy statements (PDF), advisory opinions, enforcement actions',
    structure: 'FTC standard for CIN legality: providers must be clinically integrated (not just economically), must monitor/control utilization, improve quality, reduce costs. Integration must be substantial enough to justify joint negotiation. Statement 8 specifically covers physician network joint ventures. FTC advisory opinions provide case-specific CIN guidance.',
    frequency: 'Policy statements updated periodically; advisory opinions on request',
    records: 'N/A — policy documents + ~30 health care advisory opinions',
    access: 'Free — FTC website, DOJ antitrust division website',
    cost: 'free',
    lakeOrg: 'Statement 8 and health care advisory opinions in S3, chunked and indexed. CIN formation requirements checklist derived and stored as structured reference.',
    notes: 'The FTC "clinical integration" standard is what makes a CIN legally defensible for joint price negotiation. Without genuine clinical integration (quality programs, utilization monitoring, shared protocols), a CIN is just a price-fixing cartel. FTC has issued favorable advisory opinions for CINs with strong integration programs.'
  },
  state_law: {
    name: 'State Law — Regulatory Knowledge Base',
    agency: 'Various state agencies (AG offices, insurance divisions, health policy commissions, medical boards)',
    url: null,
    format: 'Statutes, regulations, policy reports, APCD data (PDF, web, CSV)',
    structure: 'Per-state regulatory mapping: AG healthcare oversight, cost containment laws, insurance/TPA licensing, medical board credentialing, all-payer claims data access, unfair insurance practice rules. Each state has unique requirements for direct contracting, CIN formation, and TPA operations.',
    frequency: 'Varies by state — legislative sessions, AG reports (annual), insurance rules (ongoing)',
    records: 'Varies — MA has 8 mapped sources',
    access: 'Mostly free public access. State APCDs may require data use agreements.',
    cost: 'free',
    lakeOrg: 'State regulatory documents in S3 under s3://meroka-legal/{state}/. PDF text extracted, chunked, and embedded for RAG retrieval. Vector index per state for targeted context injection.',
    notes: 'State law complexity is the main barrier to multi-state expansion. Each state has unique insurance regulations, TPA licensing, and AG oversight. ERISA preemption helps (self-insured plans bypass state insurance mandates) but state fraud/abuse and corporate practice of medicine laws still apply. Starting with MA, expanding to CT, NY, NJ.'
  }
};

let sourcePanelOpen = false;

function openSourceCard(srcId) {
  const card = SOURCE_CARDS[srcId];
  if (!card) return;
  const overlay = document.getElementById('source-overlay');
  const panel = document.getElementById('source-panel');
  sourcePanelOpen = true;

  const costLabel = card.cost === 'free' ? 'Free / Public' : card.cost === 'paid' ? 'Paid License' : 'Restricted Access';
  const costClass = card.cost === 'free' ? 'pill-free' : card.cost === 'paid' ? 'pill-paid' : 'pill-restricted';

  let html = '<div class="src-card-header">';
  html += '<div class="src-card-header-info">';
  html += `<div class="src-card-title">${card.name}</div>`;
  html += `<div class="src-card-agency">${card.agency}</div>`;
  html += '</div>';
  html += '<button class="detail-close" onclick="closeSourceCard()">&times;</button>';
  html += '</div>';

  html += '<div class="src-card-body">';

  // Stat row
  html += '<div class="src-card-stat-row">';
  html += `<div class="src-card-stat"><div class="src-card-stat-val">${card.records || 'N/A'}</div><div class="src-card-stat-label">Records</div></div>`;
  html += `<div class="src-card-stat"><div class="src-card-stat-val">${card.frequency}</div><div class="src-card-stat-label">Update Freq.</div></div>`;
  html += `<div class="src-card-stat"><div class="src-card-stat-val"><span class="src-card-pill ${costClass}">${costLabel}</span></div><div class="src-card-stat-label">Cost</div></div>`;
  html += '</div>';

  // URL
  if (card.url) {
    html += '<div class="src-card-row">';
    html += '<div class="src-card-label">URL</div>';
    html += `<div class="src-card-value"><a href="${card.url}" target="_blank">${card.url}</a></div>`;
    html += '</div>';
  }
  if (card.apiUrl) {
    html += '<div class="src-card-row">';
    html += '<div class="src-card-label">API / Alt</div>';
    html += `<div class="src-card-value"><a href="${card.apiUrl}" target="_blank">${card.apiUrl}</a></div>`;
    html += '</div>';
  }

  // Format
  html += '<div class="src-card-row">';
  html += '<div class="src-card-label">Format</div>';
  html += `<div class="src-card-value"><span class="src-card-pill pill-format">${card.format}</span></div>`;
  html += '</div>';

  // Structure
  html += '<div class="src-card-row">';
  html += '<div class="src-card-label">Structure</div>';
  html += `<div class="src-card-value">${card.structure}</div>`;
  html += '</div>';

  // Access
  html += '<div class="src-card-row">';
  html += '<div class="src-card-label">Access</div>';
  html += `<div class="src-card-value">${card.access}</div>`;
  html += '</div>';

  // Lake organization
  html += '<div class="src-card-divider"></div>';
  html += '<div class="src-card-row">';
  html += '<div class="src-card-label">AWS Lake</div>';
  html += `<div class="src-card-value">${card.lakeOrg}</div>`;
  html += '</div>';

  // Notes
  if (card.notes) {
    html += '<div class="src-card-row">';
    html += '<div class="src-card-label">Notes</div>';
    html += `<div class="src-card-value"><div class="src-card-note">${card.notes}</div></div>`;
    html += '</div>';
  }

  html += '</div>'; // end body
  panel.innerHTML = html;
  overlay.classList.add('open');
}

function closeSourceCard() {
  document.getElementById('source-overlay').classList.remove('open');
  sourcePanelOpen = false;
}

// ── Source hover & click ──

document.querySelectorAll('.src-item').forEach(s => {
  s.addEventListener('mouseenter', () => {
    if (impactLocked) return;
    const sid = s.dataset.id;
    dimAll();
    s.classList.add('hl');
    s.closest('.source-group').querySelector('.sg-header').classList.add('hl');
    lake.classList.add('hl');
    const connFields = [];
    document.querySelectorAll('.field').forEach(f => {
      if (f.dataset.sources.split(',').map(x => x.trim()).includes(sid)) {
        f.classList.add('hl');
        connFields.push(f.dataset.name);
      }
    });
    hlLines(connFields, false);
    document.querySelectorAll('.proj-box[data-fields]').forEach(p => {
      const pf = p.dataset.fields.split(',').map(x => x.trim());
      if (connFields.some(cf => pf.includes(cf))) p.classList.add('hl');
    });
  });
  s.addEventListener('mouseleave', () => { if (!impactLocked) resetAll(); });
  s.addEventListener('click', (e) => {
    if (s.dataset.id === 'state_law') return; // handled by toggleStateLaw + child clicks
    if (pipeline.classList.contains('impact-mode')) {
      handleImpactClick(e);
    } else {
      openSourceCard(s.dataset.id);
    }
  });
});

// ── Source group header hover ──

document.querySelectorAll('.sg-header').forEach(h => {
  h.addEventListener('mouseenter', () => {
    if (impactLocked) return;
    const group = h.parentElement;
    const sids = Array.from(group.querySelectorAll('.src-item')).map(s => s.dataset.id);
    dimAll();
    h.classList.add('hl');
    lake.classList.add('hl');
    sids.forEach(sid => {
      const el = document.querySelector(`.src-item[data-id="${sid}"]`);
      if (el) el.classList.add('hl');
    });
    const connFields = [];
    document.querySelectorAll('.field').forEach(f => {
      const fsids = f.dataset.sources.split(',').map(x => x.trim());
      if (sids.some(sid => fsids.includes(sid))) {
        f.classList.add('hl');
        connFields.push(f.dataset.name);
      }
    });
    hlLines(connFields, false);
  });
  h.addEventListener('mouseleave', () => { if (!impactLocked) resetAll(); });
});

// ── Init ──

// ── Keyboard shortcuts ──
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    if (sourcePanelOpen) closeSourceCard();
    else if (detailPanelOpen) closeDetailPanel();
    else if (document.getElementById('backlog-overlay').classList.contains('open')) closeBacklog();
  }
});

// ── Click outside to close source card ──
document.getElementById('source-overlay').addEventListener('click', (e) => {
  if (e.target === document.getElementById('source-overlay')) closeSourceCard();
});

window.addEventListener('load', () => {
  applyCompletedStatus();
  renderStateLawChildren();
  renderProjects();
  setTimeout(drawAllLines, 120);
});
window.addEventListener('resize', drawAllLines);
</script>
</body>
</html>
